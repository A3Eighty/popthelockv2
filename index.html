<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pop the Lock</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;800&display=swap');
        body {
            font-family: 'Segoe UI', sans-serif;
            touch-action: none; /* Prevent browser zooming/scrolling globally */
            overflow: hidden;
        }
        /* Custom scrollbar for settings */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }
        
        .interactive {
            cursor: pointer;
            touch-action: manipulation; /* No double-tap zoom delay */
            user-select: none;
            -webkit-user-select: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen w-screen flex flex-col items-center justify-center overflow-hidden">

    <!-- Game Canvas -->
    <canvas id="gameCanvas" class="absolute top-0 left-0 w-full h-full z-0 touch-none"></canvas>

    <!-- UI Layer -->
    <div id="uiLayer" class="absolute top-0 left-0 w-full h-full z-10 pointer-events-none flex flex-col items-center justify-center">
        
        <!-- Score/Countdown (Center of Lock) -->
        <div id="scoreDisplay" class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-9xl font-bold opacity-80 pointer-events-none select-none">50</div>

        <!-- Start Screen -->
        <div id="startScreen" class="absolute w-full h-full flex flex-col items-center justify-center pointer-events-auto transition-opacity duration-300">
            <h1 id="gameTitle" class="text-5xl md:text-7xl font-extrabold mb-4 tracking-wider text-center" style="text-shadow: 0 0 20px rgba(250, 204, 21, 0.6);">POP THE LOCK</h1>
            <p id="gameInstruction" class="text-lg md:text-xl mb-12 opacity-80 font-light tracking-wide text-center">
                TAP WHEN THE <span id="instrBar" class="font-bold">BAR</span> HITS THE <span id="instrDot" class="font-bold">DOT</span>
            </p>
            
            <button id="startBtn" class="interactive px-12 py-4 rounded-full text-xl font-bold shadow-[0_0_20px_rgba(255,255,255,0.3)] hover:scale-105 active:scale-95 transition transform mb-6 bg-white text-black">
                PLAY
            </button>
            
            <button id="settingsBtn" class="interactive px-8 py-2 rounded-full text-sm font-bold border border-white/30 hover:bg-white/10 transition">
                SETTINGS
            </button>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="hidden absolute w-full h-full flex-col items-center justify-start pt-10 pb-10 bg-gray-900/95 pointer-events-auto backdrop-blur-sm z-50" style="touch-action: pan-y; overflow-y: auto;">
            <div class="w-full max-w-md px-6 flex flex-col gap-8">
                <div class="flex justify-between items-center">
                    <h2 class="text-3xl font-bold">SETTINGS</h2>
                    <button id="closeSettingsBtn" class="interactive text-2xl font-bold px-4 py-2 hover:text-red-400 transition">✕</button>
                </div>

                <!-- Visual Themes -->
                <div class="space-y-2">
                    <h3 class="text-sm uppercase tracking-widest text-gray-400 font-bold">Visual Theme</h3>
                    <div id="themeGrid" class="grid grid-cols-3 gap-3">
                        <!-- Generated by JS -->
                    </div>
                </div>
                
                <!-- Custom Theme Editor -->
                <div id="customThemeEditor" class="hidden space-y-3 bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-sm">Edit Custom Theme</h4>
                        <button id="deleteThemeBtn" class="interactive text-xs text-red-400 hover:text-red-300 hidden">DELETE ✕</button>
                    </div>
                    
                    <div class="space-y-2">
                        <input type="text" id="customThemeName" placeholder="Theme Name" class="interactive w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-sm text-white mb-2">
                        
                        <div class="flex justify-between items-center">
                            <label class="text-xs text-gray-400">Background</label>
                            <input type="color" id="customBg" class="interactive w-8 h-8 rounded bg-transparent cursor-pointer">
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="text-xs text-gray-400">Lock Ring</label>
                            <input type="color" id="customLock" class="interactive w-8 h-8 rounded bg-transparent cursor-pointer">
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="text-xs text-gray-400">Target Dot</label>
                            <input type="color" id="customTarget" class="interactive w-8 h-8 rounded bg-transparent cursor-pointer">
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="text-xs text-gray-400">Ticker Bar</label>
                            <input type="color" id="customTicker" class="interactive w-8 h-8 rounded bg-transparent cursor-pointer">
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="text-xs text-gray-400">UI Text</label>
                            <input type="color" id="customText" class="interactive w-8 h-8 rounded bg-transparent cursor-pointer">
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="text-xs text-gray-400">Flash Color</label>
                            <input type="color" id="customProgress" class="interactive w-8 h-8 rounded bg-transparent cursor-pointer">
                        </div>
                    </div>
                    
                    <button id="saveThemeBtn" class="interactive w-full py-2 mt-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold text-sm">SAVE THEME</button>
                </div>

                <!-- Glass UI Toggle -->
                 <div class="flex justify-between items-center bg-gray-800/50 p-3 rounded-lg">
                    <span class="text-sm font-bold">Glass UI Effect</span>
                    <label class="relative inline-flex items-center cursor-pointer interactive">
                        <input type="checkbox" id="glassToggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>

                <!-- Difficulty -->
                <div class="space-y-2">
                    <h3 class="text-sm uppercase tracking-widest text-gray-400 font-bold">Difficulty</h3>
                    <div id="diffGrid" class="flex gap-2">
                        <!-- Generated by JS -->
                    </div>
                    
                    <!-- Custom Diff Editor -->
                    <div id="customDiffEditor" class="hidden space-y-4 bg-gray-800 p-4 rounded-xl mt-2">
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-xs font-bold">Base Speed</span>
                                <span id="customSpeedVal" class="text-xs text-gray-400">Normal</span>
                            </div>
                            <input type="range" id="customSpeedRange" min="10" max="60" value="20" class="interactive w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-xs font-bold">Target Size</span>
                                <span id="customSizeVal" class="text-xs text-gray-400">Normal</span>
                            </div>
                            <input type="range" id="customSizeRange" min="15" max="50" value="32" class="interactive w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                </div>
                
                <!-- Audio -->
                <div class="space-y-2">
                    <h3 class="text-sm uppercase tracking-widest text-gray-400 font-bold">Sound Pack</h3>
                    <div id="soundGrid" class="grid grid-cols-2 gap-2">
                        <!-- Generated by JS -->
                    </div>
                    
                    <!-- Custom Sound Editor -->
                    <div id="customSoundEditor" class="hidden space-y-4 bg-gray-800 p-4 rounded-xl border border-purple-500/30 mt-2">
                        <div class="flex justify-between items-center">
                             <h4 class="font-bold text-sm text-purple-300">Sound Lab</h4>
                             <select id="soundTypeSelector" class="interactive bg-gray-900 border border-gray-600 text-xs rounded px-2 py-1">
                                 <option value="pop">Edit: Pop (Success)</option>
                                 <option value="fail">Edit: Fail (Death)</option>
                             </select>
                        </div>
                       
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-xs">Waveform</span>
                                <select id="customWaveform" class="interactive bg-gray-900 border border-gray-600 text-xs rounded px-2 py-1">
                                    <option value="sine">Sine (Soft)</option>
                                    <option value="square">Square (Retro)</option>
                                    <option value="sawtooth">Sawtooth (Sharp)</option>
                                    <option value="triangle">Triangle (Mellow)</option>
                                </select>
                            </div>
                            
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-xs">Start Freq</span>
                                    <span id="startFreqVal" class="text-xs text-gray-400">800</span>
                                </div>
                                <input type="range" id="startFreq" min="50" max="2000" step="10" class="interactive w-full h-2 bg-gray-700 rounded-lg appearance-none">
                            </div>
                            
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-xs">End Freq</span>
                                    <span id="endFreqVal" class="text-xs text-gray-400">1200</span>
                                </div>
                                <input type="range" id="endFreq" min="50" max="2000" step="10" class="interactive w-full h-2 bg-gray-700 rounded-lg appearance-none">
                            </div>
                            
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-xs">Duration</span>
                                    <span id="durationVal" class="text-xs text-gray-400">0.1</span>
                                </div>
                                <input type="range" id="soundDuration" min="0.05" max="1.0" step="0.05" class="interactive w-full h-2 bg-gray-700 rounded-lg appearance-none">
                            </div>
                            
                            <button id="testSoundBtn" class="interactive w-full py-2 bg-purple-600 hover:bg-purple-500 rounded font-bold text-xs">TEST SOUND</button>
                        </div>
                    </div>
                </div>
                
                <div class="h-10"></div> <!-- Spacer -->
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="gameOverScreen" class="hidden absolute w-full h-full flex flex-col items-center justify-center pointer-events-auto z-40 bg-black/80 backdrop-blur-sm">
            <h2 class="text-5xl font-bold text-red-500 mb-2">FAILED</h2>
            <p id="finalScore" class="text-xl mb-8">Remaining: 12</p>
            <button id="retryBtn" class="interactive px-10 py-3 rounded-full text-lg font-bold bg-white text-black mb-4 hover:scale-105 transition">TRY AGAIN</button>
            <button id="menuBtn" class="interactive text-gray-400 hover:text-white transition underline">Main Menu</button>
        </div>

        <!-- Win Screen -->
        <div id="winScreen" class="hidden absolute w-full h-full flex flex-col items-center justify-center pointer-events-auto z-40 bg-black/80 backdrop-blur-sm">
            <h2 class="text-5xl font-bold text-green-400 mb-2">UNLOCKED!</h2>
            <p class="text-xl mb-8">All 50 Dots Popped</p>
            <button id="playAgainBtn" class="interactive px-10 py-3 rounded-full text-lg font-bold bg-white text-black mb-4 hover:scale-105 transition">PLAY AGAIN</button>
            <button id="menuBtnWin" class="interactive text-gray-400 hover:text-white transition underline">Main Menu</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // UI Elements
        const uiLayer = document.getElementById('uiLayer');
        const startScreen = document.getElementById('startScreen');
        const settingsScreen = document.getElementById('settingsScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const winScreen = document.getElementById('winScreen');
        const scoreDisplay = document.getElementById('scoreDisplay');
        
        const startBtn = document.getElementById('startBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const retryBtn = document.getElementById('retryBtn');
        const playAgainBtn = document.getElementById('playAgainBtn');
        const menuBtn = document.getElementById('menuBtn');
        const menuBtnWin = document.getElementById('menuBtnWin');
        const finalScoreEl = document.getElementById('finalScore');
        
        const gameTitle = document.getElementById('gameTitle');
        const gameInstruction = document.getElementById('gameInstruction');
        const instrBar = document.getElementById('instrBar');
        const instrDot = document.getElementById('instrDot');
        
        const themeGrid = document.getElementById('themeGrid');
        const diffGrid = document.getElementById('diffGrid');
        const soundGrid = document.getElementById('soundGrid');
        const customThemeEditor = document.getElementById('customThemeEditor');
        const customDiffEditor = document.getElementById('customDiffEditor');
        const deleteThemeBtn = document.getElementById('deleteThemeBtn');
        const saveThemeBtn = document.getElementById('saveThemeBtn');
        
        const customSpeedRange = document.getElementById('customSpeedRange');
        const customSpeedVal = document.getElementById('customSpeedVal');
        const customSizeRange = document.getElementById('customSizeRange');
        const customSizeVal = document.getElementById('customSizeVal');
        const glassToggle = document.getElementById('glassToggle');
        
        // Sound Editor
        const customSoundEditor = document.getElementById('customSoundEditor');
        const customWaveform = document.getElementById('customWaveform');
        const startFreqRange = document.getElementById('startFreq');
        const endFreqRange = document.getElementById('endFreq');
        const soundDurationRange = document.getElementById('soundDuration');
        const testSoundBtn = document.getElementById('testSoundBtn');
        const startFreqVal = document.getElementById('startFreqVal');
        const endFreqVal = document.getElementById('endFreqVal');
        const durationVal = document.getElementById('durationVal');

        // Data
        const THEMES = {
            'ARCADE': { name: 'Arcade', bg: '#111827', lock: '#374151', target: '#facc15', ticker: '#ef4444', text: '#ffffff', progress: '#22c55e' },
            'MINIMAL': { name: 'Minimal', bg: '#e5e7eb', lock: '#9ca3af', target: '#3b82f6', ticker: '#1f2937', text: '#1f2937', progress: '#059669' },
            'NEON': { name: 'Neon', bg: '#000000', lock: '#262626', target: '#00ff00', ticker: '#ff00ff', text: '#00ff00', progress: '#00ff00' },
            'OCEAN': { name: 'Ocean', bg: '#0f172a', lock: '#1e293b', target: '#38bdf8', ticker: '#f472b6', text: '#e0f2fe', progress: '#2dd4bf' },
            'VAPOR': { name: 'Vapor', bg: '#2d1b4e', lock: '#4c1d95', target: '#00ffff', ticker: '#ff00ff', text: '#f3e8ff', progress: '#00ffff' },
            'FOREST': { name: 'Forest', bg: '#14532d', lock: '#166534', target: '#a3e635', ticker: '#fbbf24', text: '#f0fdf4', progress: '#4ade80' },
            'SUNSET': { name: 'Sunset', bg: '#431407', lock: '#7c2d12', target: '#fb923c', ticker: '#fde047', text: '#fff7ed', progress: '#f97316' },
            'MONO': { name: 'Mono', bg: '#171717', lock: '#404040', target: '#ffffff', ticker: '#a3a3a3', text: '#fafafa', progress: '#ffffff' },
            'CUSTOM': { name: 'Custom', bg: '#111827', lock: '#374151', target: '#facc15', ticker: '#ef4444', text: '#ffffff', progress: '#22c55e' }
        };

        const DIFFICULTIES = {
            'EASY': { label: 'Chill', speed: 0.0015, inc: 0.00008, tol: 0.35, size: 32 },
            'NORMAL': { label: 'Normal', speed: 0.0020, inc: 0.00012, tol: 0.28, size: 32 },
            'HARD': { label: 'Sweaty', speed: 0.0028, inc: 0.00018, tol: 0.22, size: 32 },
            'CUSTOM': { label: 'Custom', speed: 0.0020, inc: 0.00012, tol: 0.28, size: 32 }
        };

        const SOUND_PACKS = {
            'DEFAULT': { label: 'Classic' },
            'BUBBLE': { label: 'Bubble' },
            'RETRO': { label: '8-Bit' },
            'CLICK': { label: 'Mechanical' },
            'SPACE': { label: 'Space' },
            'LOFI': { label: 'Lofi' },
            'DREAMY': { label: 'Dreamy' },
            'WOOD': { label: 'Wood' },
            'BELL': { label: 'Bell' },
            'CUSTOM': { label: 'Custom' }
        };
        
        let customSounds = {
            pop: { waveform: 'sine', startFreq: 800, endFreq: 1200, duration: 0.1 },
            fail: { waveform: 'sawtooth', startFreq: 150, endFreq: 80, duration: 0.4 }
        };
        let currentEditType = 'pop';

        // State
        let activeTheme = 'ARCADE';
        let activeDifficulty = 'NORMAL';
        let activeSoundPack = 'DEFAULT';
        let glassMode = false;
        
        let gameState = 'IDLE'; 
        let score = 0;
        const MAX_SCORE = 50;
        
        let centerX, centerY, radius;
        let angle = 0; 
        let velocity = 0; 
        let targetAngle = 0; 
        let direction = 1; 
        let lastTime = 0;
        let lastHitTime = 0;

        // Audio
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            if (activeSoundPack === 'CUSTOM') {
                const params = customSounds[type];
                
                if (params) {
                    osc.type = params.waveform;
                    osc.frequency.setValueAtTime(params.startFreq, now);
                    const targetFreq = Math.max(1, params.endFreq);
                    osc.frequency.exponentialRampToValueAtTime(targetFreq, now + params.duration);
                    gainNode.gain.setValueAtTime(0.4, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + params.duration);
                    osc.start(); osc.stop(now + params.duration + 0.05);
                } else if (type === 'win') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(523, now); 
                    gainNode.gain.setValueAtTime(0.3, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.8);
                    osc.start(); osc.stop(now + 0.8);
                }
                return;
            }
            
            if (activeSoundPack === 'WOOD') {
                 if (type === 'pop') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); gainNode.gain.setValueAtTime(0.6, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05); osc.start(); osc.stop(now + 0.05);
                } else if (type === 'fail') {
                    osc.type = 'square'; osc.frequency.setValueAtTime(100, now); gainNode.gain.setValueAtTime(0.4, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2); osc.start(); osc.stop(now + 0.2);
                } else if (type === 'win') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(523, now); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5); osc.start(); osc.stop(now + 0.5);
                }
            }
            else if (activeSoundPack === 'BELL') {
                 if (type === 'pop') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(1200, now); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5); osc.start(); osc.stop(now + 0.5);
                } else if (type === 'fail') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4); osc.start(); osc.stop(now + 0.4);
                } else if (type === 'win') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(880, now); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 1.5); osc.start(); osc.stop(now + 1.5);
                }
            }
            else if (activeSoundPack === 'DEFAULT') {
                if (type === 'pop') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.08); gainNode.gain.setValueAtTime(0.4, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.08); osc.start(); osc.stop(now + 0.08);
                } else if (type === 'fail') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(80, now + 0.4); gainNode.gain.setValueAtTime(0.4, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4); osc.start(); osc.stop(now + 0.4);
                } else if (type === 'win') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(523, now); osc.frequency.setValueAtTime(659, now + 0.1); osc.frequency.setValueAtTime(783, now + 0.2); osc.frequency.setValueAtTime(1046, now + 0.3); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.8); osc.start(); osc.stop(now + 0.8);
                }
            } 
            else if (activeSoundPack === 'BUBBLE') {
                if (type === 'pop') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(300, now); osc.frequency.linearRampToValueAtTime(600, now + 0.15); gainNode.gain.setValueAtTime(0.5, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.15); osc.start(); osc.stop(now + 0.15);
                } else if (type === 'fail') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(50, now + 0.3); gainNode.gain.setValueAtTime(0.5, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.3); osc.start(); osc.stop(now + 0.3);
                } else if (type === 'win') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(800, now + 0.2); osc.frequency.linearRampToValueAtTime(1200, now + 0.4); gainNode.gain.setValueAtTime(0.4, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.8); osc.start(); osc.stop(now + 0.8);
                }
            }
            else if (activeSoundPack === 'RETRO') {
                if (type === 'pop') {
                    osc.type = 'square'; osc.frequency.setValueAtTime(600, now); osc.frequency.setValueAtTime(1200, now + 0.05); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.1); osc.start(); osc.stop(now + 0.1);
                } else if (type === 'fail') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(50, now + 0.4); gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.4); osc.start(); osc.stop(now + 0.4);
                } else if (type === 'win') {
                    osc.type = 'square'; osc.frequency.setValueAtTime(440, now); osc.frequency.setValueAtTime(880, now + 0.1); osc.frequency.setValueAtTime(1760, now + 0.2); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.6); osc.start(); osc.stop(now + 0.6);
                }
            }
            else if (activeSoundPack === 'CLICK') {
                if (type === 'pop') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(2000, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.02); gainNode.gain.setValueAtTime(0.8, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.02); osc.start(); osc.stop(now + 0.03);
                } else if (type === 'fail') {
                    osc.type = 'square'; osc.frequency.setValueAtTime(100, now); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(); osc.stop(now + 0.1);
                } else if (type === 'win') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(1000, now); osc.frequency.linearRampToValueAtTime(2000, now + 0.1); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.3); osc.start(); osc.stop(now + 0.3);
                }
            }
            else if (activeSoundPack === 'SPACE') {
                if (type === 'pop') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.2); gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2); osc.start(); osc.stop(now + 0.2);
                } else if (type === 'fail') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(50, now + 0.5); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.5); osc.start(); osc.stop(now + 0.5);
                } else if (type === 'win') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(200, now); osc.frequency.exponentialRampToValueAtTime(2000, now + 0.6); gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.6); osc.start(); osc.stop(now + 0.6);
                }
            }
            else if (activeSoundPack === 'LOFI') {
                if (type === 'pop') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(300, now + 0.1); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.1); osc.start(); osc.stop(now + 0.1);
                } else if (type === 'fail') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(50, now + 0.2); gainNode.gain.setValueAtTime(0.5, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.2); osc.start(); osc.stop(now + 0.2);
                } else if (type === 'win') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(300, now); osc.frequency.setValueAtTime(400, now + 0.1); osc.frequency.setValueAtTime(500, now + 0.2); osc.frequency.setValueAtTime(600, now + 0.3); gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.8); osc.start(); osc.stop(now + 0.8);
                }
            }
            else if (activeSoundPack === 'DREAMY') {
                if (type === 'pop') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(523.25, now); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.8); osc.start(); osc.stop(now + 0.8);
                    const osc2 = audioCtx.createOscillator(); const gain2 = audioCtx.createGain(); osc2.connect(gain2); gain2.connect(audioCtx.destination); osc2.type = 'sine'; osc2.frequency.setValueAtTime(1046.50, now); gain2.gain.setValueAtTime(0.1, now); gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.6); osc2.start(); osc2.stop(now + 0.6);
                } else if (type === 'fail') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(140, now + 0.5); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.5); osc.start(); osc.stop(now + 0.5);
                } else if (type === 'win') {
                    const freqs = [523.25, 659.25, 783.99, 1046.50]; freqs.forEach((f, i) => { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'sine'; o.frequency.setValueAtTime(f, now + i*0.1); g.gain.setValueAtTime(0.1, now + i*0.1); g.gain.linearRampToValueAtTime(0, now + 2.0); o.start(); o.stop(now + 2.0); });
                }
            }
        }

        function bindBtn(idOrEl, action) {
            const el = typeof idOrEl === 'string' ? document.getElementById(idOrEl) : idOrEl;
            if (!el) return;
            el.addEventListener('click', (e) => {
                if (el.tagName !== 'INPUT' && el.tagName !== 'SELECT') { e.preventDefault(); }
                action(e);
            });
        }
        
        function initMenus() {
            themeGrid.innerHTML = '';
            for (const [key, theme] of Object.entries(THEMES)) {
                const btn = document.createElement('button');
                const isCustom = key.startsWith('CUSTOM') && key !== 'CUSTOM';
                btn.className = `p-3 rounded-lg font-bold text-sm uppercase tracking-wide transition transform hover:scale-105 border-2 relative overflow-hidden touch-manipulation ${activeTheme === key ? 'border-white ring-2 ring-offset-2 ring-offset-gray-900 ring-blue-500' : 'border-transparent'}`;
                btn.style.backgroundColor = theme.bg;
                btn.style.color = theme.target;
                btn.style.borderColor = theme.lock;
                btn.innerText = theme.name;
                if (isCustom) {
                    const indicator = document.createElement('div');
                    indicator.className = "absolute top-1 right-1 w-2 h-2 rounded-full bg-blue-500 shadow-sm";
                    btn.appendChild(indicator);
                }
                bindBtn(btn, () => setTheme(key));
                themeGrid.appendChild(btn);
            }
            
            diffGrid.innerHTML = '';
            for (const [key, diff] of Object.entries(DIFFICULTIES)) {
                const btn = document.createElement('button');
                btn.className = `flex-1 py-2 rounded-md font-bold text-sm transition touch-manipulation ${activeDifficulty === key ? 'bg-blue-600 text-white shadow-md' : 'text-gray-400 hover:text-white hover:bg-gray-700'}`;
                btn.innerText = diff.label;
                bindBtn(btn, () => setDifficulty(key));
                diffGrid.appendChild(btn);
            }

            soundGrid.innerHTML = '';
            for (const [key, pack] of Object.entries(SOUND_PACKS)) {
                const btn = document.createElement('button');
                btn.className = `flex-1 py-2 rounded-md font-bold text-sm transition touch-manipulation ${activeSoundPack === key ? 'bg-purple-600 text-white shadow-md' : 'text-gray-400 hover:text-white hover:bg-gray-700'}`;
                btn.innerText = pack.label;
                bindBtn(btn, () => setSoundPack(key));
                soundGrid.appendChild(btn);
            }
        }
        
        function setTheme(key) {
            activeTheme = key;
            const t = THEMES[key];
            document.body.style.backgroundColor = t.bg;
            document.body.style.color = t.text;

            if (key.startsWith('CUSTOM')) {
                customThemeEditor.classList.remove('hidden');
                document.getElementById('customBg').value = t.bg;
                document.getElementById('customLock').value = t.lock;
                document.getElementById('customTarget').value = t.target;
                document.getElementById('customTicker').value = t.ticker;
                document.getElementById('customText').value = t.text;
                document.getElementById('customProgress').value = t.progress;
                document.getElementById('customThemeName').value = t.name;
                deleteThemeBtn.classList.toggle('hidden', key === 'CUSTOM');
            } else {
                customThemeEditor.classList.add('hidden');
            }
            
            if (gameTitle) {
                gameTitle.style.color = t.target;
                gameTitle.style.textShadow = `0 0 15px ${t.target}80`; 
            }
            if (gameInstruction) {
                gameInstruction.style.color = t.text;
                gameInstruction.style.opacity = '0.8';
            }
            if (instrBar) {
                instrBar.style.color = t.ticker;
            }
            if (instrDot) {
                instrDot.style.color = t.target;
            }

            // Update buttons to match theme
            const buttons = [startBtn, retryBtn, playAgainBtn];
            const classesToRemove = [
                'bg-yellow-500', 'hover:bg-yellow-400', 'border-yellow-300', 'text-black', 
                'bg-white', 'hover:bg-gray-200',
                'shadow-[0_0_20px_rgba(234,179,8,0.6)]'
            ];
            
            buttons.forEach(btn => {
                btn.classList.remove(...classesToRemove);
                // Force remove inline styles to reset clean if needed, but we set them below
                btn.style.backgroundColor = t.target;
                btn.style.borderColor = t.lock;
                btn.style.boxShadow = `0 0 20px ${t.target}80`;
                
                // Determine text color based on brightness
                // Simple heuristic: if target is dark, white text. Else black.
                // Most targets are bright (Yellow, Cyan, Green). So black is safe.
                // BUT Ocean target is #38bdf8 (Sky Blue), Neon #00ff00. 
                // Mono target is White.
                // Let's default to black text for high visibility on bright buttons.
                btn.style.color = '#000000'; 
            });
            
            applyGlassState();
            initMenus();
            draw();
        }

        function applyGlassState() {
            if (glassMode) {
                settingsScreen.classList.remove('bg-gray-900/95', 'border-gray-700');
                settingsScreen.classList.add('bg-gray-900/40', 'backdrop-blur-xl', 'border-white/20', 'shadow-[0_0_30px_rgba(0,0,0,0.5)]');
            } else {
                settingsScreen.classList.add('bg-gray-900/95', 'border-gray-700');
                settingsScreen.classList.remove('bg-gray-900/40', 'backdrop-blur-xl', 'border-white/20', 'shadow-[0_0_30px_rgba(0,0,0,0.5)]');
            }
        }

        function toggleGlass() {
            glassMode = !glassMode;
            glassToggle.checked = glassMode;
            localStorage.setItem('popLockGlassMode', glassMode);
            applyGlassState();
        }
        
        function setDifficulty(key) {
            activeDifficulty = key;
            
            if (key === 'CUSTOM') {
                customDiffEditor.classList.remove('hidden');
                const customSettings = DIFFICULTIES['CUSTOM'];
                customSpeedRange.value = Math.round(customSettings.speed * 10000);
                customSizeRange.value = customSettings.size;
                updateCustomDiffDisplay();
            } else {
                customDiffEditor.classList.add('hidden');
            }
            initMenus();
        }
        
        function updateCustomDiffDisplay() {
            const speedVal = parseInt(customSpeedRange.value);
            let speedText = "Normal";
            if (speedVal < 15) speedText = "Super Chill";
            else if (speedVal < 20) speedText = "Chill";
            else if (speedVal === 20) speedText = "Normal";
            else if (speedVal < 30) speedText = "Fast";
            else if (speedVal < 45) speedText = "Sweaty";
            else speedText = "Insane";
            
            customSpeedVal.innerText = speedText + ` (${speedVal})`;
            DIFFICULTIES['CUSTOM'].speed = speedVal / 10000;
            
            const sizeVal = parseInt(customSizeRange.value);
            let sizeText = "Normal";
            if (sizeVal < 20) sizeText = "Tiny";
            else if (sizeVal < 32) sizeText = "Small";
            else if (sizeVal === 32) sizeText = "Normal";
            else if (sizeVal < 45) sizeText = "Large";
            else sizeText = "Huge";
            
            customSizeVal.innerText = sizeText + ` (${sizeVal}px)`;
            DIFFICULTIES['CUSTOM'].size = sizeVal;
        }

        function setSoundPack(key) {
            activeSoundPack = key;
            localStorage.setItem('popLockSoundPack', key);
            playSound('pop'); 
            
            if (key === 'CUSTOM') {
                customSoundEditor.classList.remove('hidden');
            } else {
                customSoundEditor.classList.add('hidden');
            }
            
            initMenus();
        }

        function updateCustomTheme(prop, val) {
            if (activeTheme.startsWith('CUSTOM')) {
                THEMES[activeTheme][prop] = val;
                setTheme(activeTheme);
            }
        }

        function saveCustomTheme() {
            const nameInput = document.getElementById('customThemeName');
            let name = nameInput.value.trim();
            if (!name) name = 'My Theme';
            
            if (activeTheme === 'CUSTOM') {
                const newKey = 'CUSTOM_' + Date.now();
                const newTheme = { ...THEMES['CUSTOM'], name: name };
                THEMES[newKey] = newTheme;
                activeTheme = newKey;
            } else if (activeTheme.startsWith('CUSTOM_')) {
                THEMES[activeTheme].name = name;
            }

            const savedThemes = {};
            for (const key in THEMES) {
                if (key.startsWith('CUSTOM_')) {
                    savedThemes[key] = THEMES[key];
                }
            }
            localStorage.setItem('popLockSavedThemes', JSON.stringify(savedThemes));
            customThemeEditor.classList.add('hidden');
            initMenus(); 
        }

        function deleteCustomTheme() {
            if (activeTheme.startsWith('CUSTOM_')) {
                delete THEMES[activeTheme];
                const savedThemes = {};
                for (const key in THEMES) {
                    if (key.startsWith('CUSTOM_')) {
                        savedThemes[key] = THEMES[key];
                    }
                }
                localStorage.setItem('popLockSavedThemes', JSON.stringify(savedThemes));
                setTheme('ARCADE');
            }
        }

        function loadSavedThemes() {
            const savedThemes = JSON.parse(localStorage.getItem('popLockSavedThemes') || '{}');
            Object.assign(THEMES, savedThemes);
            
            const savedSound = localStorage.getItem('popLockSoundPack');
            if (savedSound && SOUND_PACKS[savedSound]) {
                activeSoundPack = savedSound;
            }

            const savedGlass = localStorage.getItem('popLockGlassMode');
            if (savedGlass === 'true') {
                glassMode = true;
                glassToggle.checked = true;
                applyGlassState();
            }
            
            const savedCustomSound = localStorage.getItem('popLockCustomSound');
            if (savedCustomSound) {
                try {
                    const parsed = JSON.parse(savedCustomSound);
                    if (parsed.waveform) {
                        customSounds.pop = parsed;
                    } else {
                        customSounds = parsed;
                    }
                } catch(e) {}
            }
            updateSoundEditorUI();
        }
        
        function updateSoundEditorUI() {
            const params = customSounds[currentEditType];
            if (!params) return;
            
            customWaveform.value = params.waveform;
            startFreqRange.value = params.startFreq;
            endFreqRange.value = params.endFreq;
            soundDurationRange.value = params.duration;
            
            startFreqVal.innerText = params.startFreq;
            endFreqVal.innerText = params.endFreq;
            durationVal.innerText = params.duration;
        }
        
        function updateCustomSound() {
            customSounds[currentEditType] = {
                waveform: customWaveform.value,
                startFreq: parseInt(startFreqRange.value),
                endFreq: parseInt(endFreqRange.value),
                duration: parseFloat(soundDurationRange.value)
            };
            
            startFreqVal.innerText = startFreqRange.value;
            endFreqVal.innerText = endFreqRange.value;
            durationVal.innerText = soundDurationRange.value;
            
            localStorage.setItem('popLockCustomSound', JSON.stringify(customSounds));
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            centerX = canvas.width / 2;
            centerY = canvas.height / 2;
            radius = Math.min(canvas.width, canvas.height) * 0.22;
        }
        
        window.addEventListener('resize', resize);
        
        const soundTypeSelector = document.getElementById('soundTypeSelector');
        soundTypeSelector.addEventListener('change', (e) => {
            currentEditType = e.target.value;
            updateSoundEditorUI();
        });

        customWaveform.addEventListener('change', updateCustomSound);
        startFreqRange.addEventListener('input', updateCustomSound);
        endFreqRange.addEventListener('input', updateCustomSound);
        soundDurationRange.addEventListener('input', updateCustomSound);
        
        bindBtn(testSoundBtn, () => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const temp = activeSoundPack;
            activeSoundPack = 'CUSTOM';
            playSound(currentEditType); 
            activeSoundPack = temp;
        });

        // Glass Toggle Listener
        glassToggle.addEventListener('change', toggleGlass);

        resize();
        loadSavedThemes();
        initMenus();
        setTheme(activeTheme); // Force initial theme apply for buttons

        function startGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            gameState = 'PLAYING';
            score = 0;
            angle = -Math.PI / 2; 
            direction = 1; 
            lastHitTime = 0; 
            
            const diff = DIFFICULTIES[activeDifficulty];
            velocity = diff.speed;
            
            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            winScreen.classList.add('hidden');
            
            scoreDisplay.classList.remove('hidden');
            scoreDisplay.innerText = MAX_SCORE - score;
            
            spawnTarget();
            
            setTimeout(() => {
                window.addEventListener('pointerdown', handleInput);
                window.addEventListener('touchstart', handleInput, { passive: false });
                window.addEventListener('keydown', handleKeyInput);
            }, 100);
            
            lastTime = performance.now();
            requestAnimationFrame(loop);
        }

        function returnToMenu() {
            gameState = 'IDLE';
            scoreDisplay.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            winScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            
            window.removeEventListener('pointerdown', handleInput);
            window.removeEventListener('touchstart', handleInput);
            window.removeEventListener('keydown', handleKeyInput);
            
            draw();
        }

        function openSettings() {
            startScreen.classList.add('opacity-0', 'pointer-events-none');
            settingsScreen.classList.remove('hidden');
            settingsScreen.classList.add('flex');
        }
        
        function closeSettings() {
            settingsScreen.classList.add('hidden');
            settingsScreen.classList.remove('flex');
            startScreen.classList.remove('opacity-0', 'pointer-events-none');
        }

        function spawnTarget() {
            let valid = false;
            while (!valid) {
                targetAngle = Math.random() * Math.PI * 2;
                let diff = Math.abs(getAngleDifference(angle, targetAngle));
                if (diff > 1.0 && diff < 4.5) { 
                    valid = true;
                }
            }
        }
        
        function gameOver() {
            gameState = 'GAMEOVER';
            window.removeEventListener('pointerdown', handleInput);
            window.removeEventListener('touchstart', handleInput);
            window.removeEventListener('keydown', handleKeyInput);
            
            scoreDisplay.classList.add('hidden');
            gameOverScreen.classList.remove('hidden');
            finalScoreEl.innerText = 'Remaining: ' + (MAX_SCORE - score);
            
            const intensity = 10;
            canvas.style.transform = `translate(${intensity}px, ${intensity}px)`;
            setTimeout(() => canvas.style.transform = `translate(-${intensity}px, -${intensity}px)`, 50);
            setTimeout(() => canvas.style.transform = `translate(${intensity}px, -${intensity}px)`, 100);
            setTimeout(() => canvas.style.transform = 'translate(0, 0)', 150);
        }
        
        function gameWin() {
            gameState = 'WON';
            window.removeEventListener('pointerdown', handleInput);
            window.removeEventListener('touchstart', handleInput);
            window.removeEventListener('keydown', handleKeyInput);
            
            scoreDisplay.classList.add('hidden');
            winScreen.classList.remove('hidden');
        }

        let lastInputTime = 0;
        function handleInput(e) {
            const now = performance.now();
            if (now - lastInputTime < 50) return;
            lastInputTime = now;

            if (gameState !== 'PLAYING') return;
            
            if (e && e.cancelable && e.preventDefault) e.preventDefault();

            const diffVal = getAngleDifference(angle, targetAngle);
            const currentDiffSettings = DIFFICULTIES[activeDifficulty];
            
            let effectiveTol = currentDiffSettings.tol;
            if (currentDiffSettings.size && radius > 0) {
                const tickerHalfWidthAngle = 10 / radius; 
                const targetHalfWidthAngle = currentDiffSettings.size / radius;
                effectiveTol = tickerHalfWidthAngle + targetHalfWidthAngle + 0.05; 
            }

            if (Math.abs(diffVal) <= effectiveTol) {
                score++;
                lastHitTime = performance.now();
                scoreDisplay.innerText = MAX_SCORE - score;
                
                if (score >= MAX_SCORE) {
                    playSound('win');
                    gameWin();
                    return;
                }
                
                playSound('pop');
                
                direction *= -1;
                velocity = (currentDiffSettings.speed + (score * currentDiffSettings.inc)) * direction;
                
                const minDist = Math.PI / 3; 
                const maxDist = Math.PI * 1.5; 
                const range = maxDist - minDist;
                const dist = minDist + (Math.random() * range);
                
                targetAngle = angle + (dist * direction);
                targetAngle = targetAngle % (Math.PI * 2);
                if (targetAngle < 0) targetAngle += Math.PI * 2;
                
            } else {
                playSound('fail');
                gameOver();
            }
        }
        
        function handleKeyInput(e) {
            if (e.code === 'Space' || e.code === 'Enter') {
                handleInput();
            }
        }
        
        function getAngleDifference(a1, a2) {
            let diff = (a2 - a1 + Math.PI) % (Math.PI * 2) - Math.PI;
            if (diff < -Math.PI) diff += Math.PI * 2;
            return diff;
        }
        
        function loop(timestamp) {
            if (gameState !== 'PLAYING') {
                draw();
                return;
            }
            
            const dt = timestamp - lastTime;
            lastTime = timestamp;
            const safeDt = Math.min(dt, 50);
            
            const prevAngle = angle;
            angle += velocity * safeDt;
            angle = angle % (Math.PI * 2);
            if (angle < 0) angle += Math.PI * 2;
            
            draw();
            requestAnimationFrame(loop);
        }
        
        function draw() {
            const t = THEMES[activeTheme];
            const now = performance.now();
            const timeSinceHit = now - lastHitTime;
            const flashDuration = 400;
            const isFlashing = timeSinceHit < flashDuration;
            const diffSettings = DIFFICULTIES[activeDifficulty];
            const dotSize = diffSettings.size || 32;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.lineWidth = 50; 
            ctx.strokeStyle = t.lock;
            ctx.stroke();

            if (isFlashing) {
                ctx.save();
                const progress = timeSinceHit / flashDuration;
                const alpha = 0.8 * (1 - progress);
                
                ctx.globalAlpha = alpha;
                ctx.globalCompositeOperation = 'lighter';
                
                ctx.lineWidth = 6;
                ctx.strokeStyle = t.progress;
                ctx.shadowColor = t.progress;
                ctx.shadowBlur = 50;
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius + 28, 0, Math.PI * 2);
                ctx.stroke();
                
                ctx.restore();
            }
            
            const targetX = centerX + Math.cos(targetAngle) * radius;
            const targetY = centerY + Math.sin(targetAngle) * radius;
            
            ctx.beginPath();
            ctx.arc(targetX, targetY, dotSize, 0, Math.PI * 2);
            ctx.fillStyle = t.target;
            ctx.shadowColor = t.target;
            ctx.shadowBlur = 25;
            ctx.fill();
            ctx.shadowBlur = 0; 
            
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(angle);
            ctx.translate(radius, 0);
            
            ctx.fillStyle = t.ticker;
            ctx.shadowColor = t.ticker;
            ctx.shadowBlur = 15;
            
            roundRect(ctx, -40, -10, 80, 20, 10); 
            
            ctx.fill();
            ctx.restore();
        }
        
        function roundRect(ctx, x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.arcTo(x + w, y, x + w, y + h, r);
            ctx.arcTo(x + w, y + h, x, y + h, r);
            ctx.arcTo(x, y + h, x, y, r);
            ctx.arcTo(x, y, x + w, y, r);
            ctx.closePath();
        }

        bindBtn(startBtn, startGame);
        bindBtn(retryBtn, startGame);
        bindBtn(playAgainBtn, startGame);
        bindBtn(settingsBtn, openSettings);
        bindBtn(closeSettingsBtn, closeSettings);
        bindBtn(menuBtn, returnToMenu);
        bindBtn(menuBtnWin, returnToMenu);
        bindBtn(saveThemeBtn, saveCustomTheme);
        bindBtn(deleteThemeBtn, deleteCustomTheme);
        
        document.getElementById('customBg').addEventListener('input', (e) => updateCustomTheme('bg', e.target.value));
        document.getElementById('customLock').addEventListener('input', (e) => updateCustomTheme('lock', e.target.value));
        document.getElementById('customTarget').addEventListener('input', (e) => updateCustomTheme('target', e.target.value));
        document.getElementById('customTicker').addEventListener('input', (e) => updateCustomTheme('ticker', e.target.value));
        document.getElementById('customText').addEventListener('input', (e) => updateCustomTheme('text', e.target.value));
        document.getElementById('customProgress').addEventListener('input', (e) => updateCustomTheme('progress', e.target.value));
        
        customSpeedRange.addEventListener('input', updateCustomDiffDisplay);
        customSizeRange.addEventListener('input', updateCustomDiffDisplay);
    </script>
</body>
</html>