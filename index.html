<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pop the Lock Clone</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        body {
            touch-action: none; /* Prevent zoom/scroll on mobile */
            background-color: #111827; /* Gray 900 */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        canvas {
            display: block;
            margin: 0 auto;
        }
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .header-ui {
            position: absolute;
            top: 10%; /* Positioned near top */
            width: 100%;
            text-align: center;
            pointer-events: none;
        }
        .interactive {
            pointer-events: auto;
            touch-action: manipulation;
        }
        #settingsScreen {
            touch-action: pan-y;
        }
        /* Arcade font style for score */
        .arcade-font {
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: -2px;
        }
    </style>
</head>
<body class="h-screen w-screen text-white select-none">

    <!-- Header UI (Always visible or top layer) -->
    <div class="header-ui flex flex-col items-center z-10">
        <h1 id="gameTitle" class="text-5xl md:text-6xl font-black transition-colors duration-300 tracking-wider uppercase">POP THE LOCK</h1>
        <p id="gameInstruction" class="mt-4 text-sm md:text-base max-w-md px-4 font-medium tracking-wide transition-colors duration-300">
            TAP WHEN THE <span id="instrBar" class="font-bold transition-colors duration-300">BAR</span> HITS THE <span id="instrDot" class="font-bold transition-colors duration-300">DOT</span>
        </p>
    </div>

    <!-- Canvas for the game -->
    <canvas id="gameCanvas" class="absolute top-0 left-0 z-0"></canvas>

    <!-- Center UI Overlay (Start/End screens + Score) -->
    <div id="uiLayer" class="ui-overlay z-20">
        
        <!-- Score Display (In the center of the lock) -->
        <div id="scoreDisplay" class="text-9xl font-black text-white hidden drop-shadow-lg select-none" style="font-family: 'Segoe UI', sans-serif;">50</div>
        
        <div id="startScreen" class="flex flex-col items-center mt-32 transition-opacity duration-300">
            <button id="startBtn" class="interactive bg-yellow-500 hover:bg-yellow-400 text-black font-black py-4 px-12 rounded-full text-2xl shadow-[0_0_20px_rgba(234,179,8,0.6)] transition transform hover:scale-110 active:scale-95 border-4 border-yellow-300 mb-6">
                PLAY
            </button>
            <button id="settingsBtn" class="interactive bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg transition transform hover:scale-105 active:scale-95 border-2 border-gray-500">
                SETTINGS
            </button>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="hidden flex-col items-center bg-gray-900/95 p-8 rounded-2xl border-2 border-gray-700 shadow-2xl max-w-md w-full mx-4 backdrop-blur-sm interactive max-h-[80vh] overflow-y-auto">
            <h2 class="text-3xl text-white font-black mb-6 tracking-wider uppercase">SETTINGS</h2>
            
            <div class="w-full mb-6">
                <h3 class="text-gray-400 text-sm font-bold mb-3 uppercase tracking-wide">THEME</h3>
                <div class="grid grid-cols-2 gap-3" id="themeGrid">
                    <!-- Themes injected by JS -->
                </div>
            </div>

            <div id="customThemeEditor" class="hidden w-full mb-6 bg-gray-800 p-4 rounded-xl border border-gray-600">
                <h3 class="text-gray-400 text-xs font-bold mb-3 uppercase tracking-wide flex justify-between items-center">
                    Custom Colors <span class="text-[10px] opacity-50">(Live Preview)</span>
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    <label class="flex flex-col gap-1">
                        <span class="text-xs text-gray-400 font-mono">Background</span>
                        <input type="color" id="customBg" class="w-full h-8 rounded cursor-pointer bg-transparent" value="#111827">
                    </label>
                    <label class="flex flex-col gap-1">
                        <span class="text-xs text-gray-400 font-mono">Lock Ring</span>
                        <input type="color" id="customLock" class="w-full h-8 rounded cursor-pointer bg-transparent" value="#374151">
                    </label>
                    <label class="flex flex-col gap-1">
                        <span class="text-xs text-gray-400 font-mono">Target Dot</span>
                        <input type="color" id="customTarget" class="w-full h-8 rounded cursor-pointer bg-transparent" value="#facc15">
                    </label>
                    <label class="flex flex-col gap-1">
                        <span class="text-xs text-gray-400 font-mono">Ticker Bar</span>
                        <input type="color" id="customTicker" class="w-full h-8 rounded cursor-pointer bg-transparent" value="#ef4444">
                    </label>
                    <label class="flex flex-col gap-1">
                        <span class="text-xs text-gray-400 font-mono">Text</span>
                        <input type="color" id="customText" class="w-full h-8 rounded cursor-pointer bg-transparent" value="#ffffff">
                    </label>
                    <label class="flex flex-col gap-1">
                        <span class="text-xs text-gray-400 font-mono">Flash Color</span>
                        <input type="color" id="customProgress" class="w-full h-8 rounded cursor-pointer bg-transparent" value="#22c55e">
                    </label>
                </div>
                <div class="mt-4 flex gap-2 items-center">
                    <input type="text" id="customThemeName" placeholder="Theme Name" class="flex-1 bg-gray-700 text-white px-3 py-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" maxlength="12">
                    <button id="deleteThemeBtn" class="hidden bg-red-600 hover:bg-red-500 text-white px-3 py-2 rounded text-sm font-bold transition" title="Delete Theme">
                        âœ•
                    </button>
                    <button id="saveThemeBtn" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm font-bold transition">SAVE</button>
                </div>
            </div>
            
            <div class="w-full mb-6">
                <h3 class="text-gray-400 text-sm font-bold mb-3 uppercase tracking-wide">DIFFICULTY</h3>
                <div class="flex justify-between gap-2 bg-gray-800 p-1 rounded-lg" id="diffGrid">
                    <!-- Difficulty buttons injected by JS -->
                </div>
                <div id="customDiffEditor" class="hidden mt-3 w-full bg-gray-800 p-4 rounded-xl border border-gray-600">
                    <h3 class="text-gray-400 text-xs font-bold mb-3 uppercase tracking-wide flex justify-between items-center">
                        Custom Speed <span id="customSpeedVal" class="text-white font-mono">Normal</span>
                    </h3>
                    <input type="range" id="customSpeedRange" min="10" max="60" value="20" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500 touch-pan-y">
                    <p class="text-[10px] text-gray-500 mt-2 flex justify-between">
                        <span>Slow</span>
                        <span>Impossible</span>
                    </p>
                </div>
            </div>

            <div class="w-full mb-8">
                <h3 class="text-gray-400 text-sm font-bold mb-3 uppercase tracking-wide">AUDIO</h3>
                <div class="grid grid-cols-2 gap-2" id="soundGrid">
                    <!-- Sound buttons injected by JS -->
                </div>
            </div>
            
            <button id="closeSettingsBtn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition">
                DONE
            </button>
        </div>

        <div id="gameOverScreen" class="hidden flex-col items-center mt-32">
            <h2 class="text-4xl text-red-500 font-black mb-2 drop-shadow-md">GAME OVER</h2>
            <p id="finalScore" class="text-2xl text-gray-300 mb-8 font-mono">Remaining: 50</p>
            <button id="retryBtn" class="interactive bg-white hover:bg-gray-200 text-black font-bold py-3 px-10 rounded-full text-xl shadow-lg transition transform hover:scale-105 active:scale-95">
                TRY AGAIN
            </button>
            <button id="menuBtn" class="interactive mt-4 text-gray-400 hover:text-white font-bold py-2 px-6 transition text-sm uppercase tracking-wider">
                MAIN MENU
            </button>
        </div>
        
        <div id="winScreen" class="hidden flex-col items-center mt-32">
            <h2 class="text-5xl text-green-500 font-black mb-2 drop-shadow-[0_0_10px_rgba(34,197,94,0.8)]">UNLOCKED!</h2>
            <p class="text-xl text-gray-300 mb-8">Excellent Coordination!</p>
            <button id="playAgainBtn" class="interactive bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-3 px-10 rounded-full text-xl shadow-lg transition transform hover:scale-105 active:scale-95">
                PLAY AGAIN
            </button>
            <button id="menuBtnWin" class="interactive mt-4 text-gray-400 hover:text-white font-bold py-2 px-6 transition text-sm uppercase tracking-wider">
                MAIN MENU
            </button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // UI Elements
        const uiLayer = document.getElementById('uiLayer');
        const startScreen = document.getElementById('startScreen');
        const settingsScreen = document.getElementById('settingsScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const winScreen = document.getElementById('winScreen');
        const scoreDisplay = document.getElementById('scoreDisplay');
        
        const startBtn = document.getElementById('startBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const retryBtn = document.getElementById('retryBtn');
        const playAgainBtn = document.getElementById('playAgainBtn');
        const menuBtn = document.getElementById('menuBtn');
        const menuBtnWin = document.getElementById('menuBtnWin');
        const finalScoreEl = document.getElementById('finalScore');
        
        const gameTitle = document.getElementById('gameTitle');
        const gameInstruction = document.getElementById('gameInstruction');
        const instrBar = document.getElementById('instrBar');
        const instrDot = document.getElementById('instrDot');
        
        const themeGrid = document.getElementById('themeGrid');
        const diffGrid = document.getElementById('diffGrid');
        const soundGrid = document.getElementById('soundGrid');
        const customThemeEditor = document.getElementById('customThemeEditor');
        const customDiffEditor = document.getElementById('customDiffEditor');
        const deleteThemeBtn = document.getElementById('deleteThemeBtn');
        const saveThemeBtn = document.getElementById('saveThemeBtn');
        const customSpeedRange = document.getElementById('customSpeedRange');
        const customSpeedVal = document.getElementById('customSpeedVal');

        // Data
        const THEMES = {
            'ARCADE': { name: 'Arcade', bg: '#111827', lock: '#374151', target: '#facc15', ticker: '#ef4444', text: '#ffffff', progress: '#22c55e' },
            'MINIMAL': { name: 'Minimal', bg: '#e5e7eb', lock: '#9ca3af', target: '#3b82f6', ticker: '#1f2937', text: '#1f2937', progress: '#059669' },
            'NEON': { name: 'Neon', bg: '#000000', lock: '#262626', target: '#00ff00', ticker: '#ff00ff', text: '#00ff00', progress: '#00ff00' },
            'OCEAN': { name: 'Ocean', bg: '#0f172a', lock: '#1e293b', target: '#38bdf8', ticker: '#f472b6', text: '#e0f2fe', progress: '#2dd4bf' },
            'VAPOR': { name: 'Vapor', bg: '#2d1b4e', lock: '#4c1d95', target: '#00ffff', ticker: '#ff00ff', text: '#f3e8ff', progress: '#00ffff' },
            'FOREST': { name: 'Forest', bg: '#14532d', lock: '#166534', target: '#a3e635', ticker: '#fbbf24', text: '#f0fdf4', progress: '#4ade80' },
            'SUNSET': { name: 'Sunset', bg: '#431407', lock: '#7c2d12', target: '#fb923c', ticker: '#fde047', text: '#fff7ed', progress: '#f97316' },
            'MONO': { name: 'Mono', bg: '#171717', lock: '#404040', target: '#ffffff', ticker: '#a3a3a3', text: '#fafafa', progress: '#ffffff' },
            'CUSTOM': { name: 'Custom', bg: '#111827', lock: '#374151', target: '#facc15', ticker: '#ef4444', text: '#ffffff', progress: '#22c55e' }
        };

        const DIFFICULTIES = {
            'EASY': { label: 'Chill', speed: 0.0015, inc: 0.00008, tol: 0.35 },
            'NORMAL': { label: 'Normal', speed: 0.0020, inc: 0.00012, tol: 0.28 },
            'HARD': { label: 'Sweaty', speed: 0.0028, inc: 0.00018, tol: 0.22 },
            'CUSTOM': { label: 'Custom', speed: 0.0020, inc: 0.00012, tol: 0.28 }
        };

        const SOUND_PACKS = {
            'DEFAULT': { label: 'Classic' },
            'BUBBLE': { label: 'Bubble' },
            'RETRO': { label: '8-Bit' },
            'CLICK': { label: 'Mechanical' },
            'SPACE': { label: 'Space' },
            'LOFI': { label: 'Lofi' }
        };

        // State
        let activeTheme = 'ARCADE';
        let activeDifficulty = 'NORMAL';
        let activeSoundPack = 'DEFAULT';
        
        let gameState = 'IDLE'; 
        let score = 0;
        const MAX_SCORE = 50;
        
        let centerX, centerY, radius;
        let angle = 0; 
        let velocity = 0; 
        let targetAngle = 0; 
        let direction = 1; 
        let lastTime = 0;
        let lastHitTime = 0;

        // Audio
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;
            
            if (activeSoundPack === 'DEFAULT') {
                if (type === 'pop') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.exponentialRampToValueAtTime(1200, now + 0.08);
                    gainNode.gain.setValueAtTime(0.4, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.08);
                    osc.start(); osc.stop(now + 0.08);
                } else if (type === 'fail') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(80, now + 0.4);
                    gainNode.gain.setValueAtTime(0.4, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                    osc.start(); osc.stop(now + 0.4);
                } else if (type === 'win') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(523, now); 
                    osc.frequency.setValueAtTime(659, now + 0.1); 
                    osc.frequency.setValueAtTime(783, now + 0.2); 
                    osc.frequency.setValueAtTime(1046, now + 0.3); 
                    gainNode.gain.setValueAtTime(0.3, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.8);
                    osc.start(); osc.stop(now + 0.8);
                }
            } 
            else if (activeSoundPack === 'BUBBLE') {
                if (type === 'pop') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(300, now);
                    osc.frequency.linearRampToValueAtTime(600, now + 0.15);
                    gainNode.gain.setValueAtTime(0.5, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.15);
                    osc.start(); osc.stop(now + 0.15);
                } else if (type === 'fail') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(200, now);
                    osc.frequency.linearRampToValueAtTime(50, now + 0.3);
                    gainNode.gain.setValueAtTime(0.5, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(); osc.stop(now + 0.3);
                } else if (type === 'win') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(400, now);
                    osc.frequency.linearRampToValueAtTime(800, now + 0.2);
                    osc.frequency.linearRampToValueAtTime(1200, now + 0.4);
                    gainNode.gain.setValueAtTime(0.4, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.8);
                    osc.start(); osc.stop(now + 0.8);
                }
            }
            else if (activeSoundPack === 'RETRO') {
                if (type === 'pop') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(600, now);
                    osc.frequency.setValueAtTime(1200, now + 0.05);
                    gainNode.gain.setValueAtTime(0.1, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.1);
                    osc.start(); osc.stop(now + 0.1);
                } else if (type === 'fail') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(100, now);
                    osc.frequency.linearRampToValueAtTime(50, now + 0.4);
                    gainNode.gain.setValueAtTime(0.2, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.4);
                    osc.start(); osc.stop(now + 0.4);
                } else if (type === 'win') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(440, now);
                    osc.frequency.setValueAtTime(880, now + 0.1);
                    osc.frequency.setValueAtTime(1760, now + 0.2);
                    gainNode.gain.setValueAtTime(0.1, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.6);
                    osc.start(); osc.stop(now + 0.6);
                }
            }
            else if (activeSoundPack === 'CLICK') {
                if (type === 'pop') {
                    osc.type = 'triangle'; 
                    osc.frequency.setValueAtTime(2000, now);
                    osc.frequency.exponentialRampToValueAtTime(100, now + 0.02);
                    gainNode.gain.setValueAtTime(0.8, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.02);
                    osc.start(); osc.stop(now + 0.03);
                } else if (type === 'fail') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(100, now);
                    gainNode.gain.setValueAtTime(0.3, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(); osc.stop(now + 0.1);
                } else if (type === 'win') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(1000, now);
                    osc.frequency.linearRampToValueAtTime(2000, now + 0.1);
                    gainNode.gain.setValueAtTime(0.3, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(); osc.stop(now + 0.3);
                }
            }
            else if (activeSoundPack === 'SPACE') {
                if (type === 'pop') {
                    // Laser pew
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.exponentialRampToValueAtTime(100, now + 0.2);
                    gainNode.gain.setValueAtTime(0.2, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                    osc.start(); osc.stop(now + 0.2);
                } else if (type === 'fail') {
                    // Low drone
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(100, now);
                    osc.frequency.linearRampToValueAtTime(50, now + 0.5);
                    gainNode.gain.setValueAtTime(0.3, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.5);
                    osc.start(); osc.stop(now + 0.5);
                } else if (type === 'win') {
                    // Sci-fi rise
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(200, now);
                    osc.frequency.exponentialRampToValueAtTime(2000, now + 0.6);
                    gainNode.gain.setValueAtTime(0.2, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.6);
                    osc.start(); osc.stop(now + 0.6);
                }
            }
            else if (activeSoundPack === 'LOFI') {
                if (type === 'pop') {
                    // Soft tap
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(400, now);
                    osc.frequency.linearRampToValueAtTime(300, now + 0.1);
                    gainNode.gain.setValueAtTime(0.3, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.1);
                    osc.start(); osc.stop(now + 0.1);
                } else if (type === 'fail') {
                    // Muted thud
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(100, now);
                    osc.frequency.linearRampToValueAtTime(50, now + 0.2);
                    gainNode.gain.setValueAtTime(0.5, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.2);
                    osc.start(); osc.stop(now + 0.2);
                } else if (type === 'win') {
                    // Gentle chord (arpeggiated)
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(300, now);
                    osc.frequency.setValueAtTime(400, now + 0.1);
                    osc.frequency.setValueAtTime(500, now + 0.2);
                    osc.frequency.setValueAtTime(600, now + 0.3);
                    gainNode.gain.setValueAtTime(0.2, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.8);
                    osc.start(); osc.stop(now + 0.8);
                }
            }
        }

        function bindBtn(idOrEl, action) {
            const el = typeof idOrEl === 'string' ? document.getElementById(idOrEl) : idOrEl;
            if (!el) return;
            el.addEventListener('click', action);
        }
        
        function initMenus() {
            // Themes
            themeGrid.innerHTML = '';
            for (const [key, theme] of Object.entries(THEMES)) {
                const btn = document.createElement('button');
                const isCustom = key.startsWith('CUSTOM') && key !== 'CUSTOM';
                btn.className = `p-3 rounded-lg font-bold text-sm uppercase tracking-wide transition transform hover:scale-105 border-2 relative overflow-hidden touch-manipulation ${activeTheme === key ? 'border-white ring-2 ring-offset-2 ring-offset-gray-900 ring-blue-500' : 'border-transparent'}`;
                btn.style.backgroundColor = theme.bg;
                btn.style.color = theme.target;
                btn.style.borderColor = theme.lock;
                btn.innerText = theme.name;
                
                if (isCustom) {
                    const indicator = document.createElement('div');
                    indicator.className = "absolute top-1 right-1 w-2 h-2 rounded-full bg-blue-500 shadow-sm";
                    btn.appendChild(indicator);
                }

                bindBtn(btn, () => setTheme(key));
                themeGrid.appendChild(btn);
            }
            
            // Difficulty
            diffGrid.innerHTML = '';
            for (const [key, diff] of Object.entries(DIFFICULTIES)) {
                const btn = document.createElement('button');
                btn.className = `flex-1 py-2 rounded-md font-bold text-sm transition touch-manipulation ${activeDifficulty === key ? 'bg-blue-600 text-white shadow-md' : 'text-gray-400 hover:text-white hover:bg-gray-700'}`;
                btn.innerText = diff.label;
                bindBtn(btn, () => setDifficulty(key));
                diffGrid.appendChild(btn);
            }

            // Sound Packs
            soundGrid.innerHTML = '';
            for (const [key, pack] of Object.entries(SOUND_PACKS)) {
                const btn = document.createElement('button');
                btn.className = `flex-1 py-2 rounded-md font-bold text-sm transition touch-manipulation ${activeSoundPack === key ? 'bg-purple-600 text-white shadow-md' : 'text-gray-400 hover:text-white hover:bg-gray-700'}`;
                btn.innerText = pack.label;
                bindBtn(btn, () => setSoundPack(key));
                soundGrid.appendChild(btn);
            }
        }
        
        function setTheme(key) {
            activeTheme = key;
            const t = THEMES[key];
            document.body.style.backgroundColor = t.bg;
            document.body.style.color = t.text;

            if (key.startsWith('CUSTOM')) {
                customThemeEditor.classList.remove('hidden');
                // Reset values
                document.getElementById('customBg').value = t.bg;
                document.getElementById('customLock').value = t.lock;
                document.getElementById('customTarget').value = t.target;
                document.getElementById('customTicker').value = t.ticker;
                document.getElementById('customText').value = t.text;
                document.getElementById('customProgress').value = t.progress;
                document.getElementById('customThemeName').value = t.name;
                deleteThemeBtn.classList.toggle('hidden', key === 'CUSTOM');
            } else {
                customThemeEditor.classList.add('hidden');
            }
            
            if (gameTitle) {
                gameTitle.style.color = t.target;
                gameTitle.style.textShadow = `0 0 15px ${t.target}80`; 
            }
            if (gameInstruction) {
                gameInstruction.style.color = t.text;
                gameInstruction.style.opacity = '0.8';
            }
            if (instrBar) {
                instrBar.style.color = t.ticker;
            }
            if (instrDot) {
                instrDot.style.color = t.target;
            }
            
            initMenus();
            draw();
        }
        
        function setDifficulty(key) {
            activeDifficulty = key;
            
            if (key === 'CUSTOM') {
                customDiffEditor.classList.remove('hidden');
                // Load saved custom speed if exists? Or just use defaults
                // Updating the range input to match current settings
                const currentSpeed = DIFFICULTIES['CUSTOM'].speed;
                // Convert speed back to range value (10-60)
                // range val = speed * 10000
                customSpeedRange.value = Math.round(currentSpeed * 10000);
                updateCustomDiffDisplay();
            } else {
                customDiffEditor.classList.add('hidden');
            }

            initMenus();
        }
        
        function updateCustomDiffDisplay() {
            const val = parseInt(customSpeedRange.value);
            // Map value to text description
            let text = "Normal";
            if (val < 15) text = "Super Chill";
            else if (val < 20) text = "Chill";
            else if (val === 20) text = "Normal";
            else if (val < 30) text = "Fast";
            else if (val < 45) text = "Sweaty";
            else text = "Insane";
            
            customSpeedVal.innerText = text + ` (${val})`;
            
            // Update the actual difficulty object
            DIFFICULTIES['CUSTOM'].speed = val / 10000;
        }

        function setSoundPack(key) {
            activeSoundPack = key;
            localStorage.setItem('popLockSoundPack', key);
            playSound('pop'); 
            initMenus();
        }

        function updateCustomTheme(prop, val) {
            if (activeTheme.startsWith('CUSTOM')) {
                THEMES[activeTheme][prop] = val;
                setTheme(activeTheme);
            }
        }

        function saveCustomTheme() {
            const nameInput = document.getElementById('customThemeName');
            let name = nameInput.value.trim();
            if (!name) name = 'My Theme';
            
            if (activeTheme === 'CUSTOM') {
                const newKey = 'CUSTOM_' + Date.now();
                const newTheme = { ...THEMES['CUSTOM'], name: name };
                THEMES[newKey] = newTheme;
                activeTheme = newKey;
            } else if (activeTheme.startsWith('CUSTOM_')) {
                THEMES[activeTheme].name = name;
            }

            const savedThemes = {};
            for (const key in THEMES) {
                if (key.startsWith('CUSTOM_')) {
                    savedThemes[key] = THEMES[key];
                }
            }
            localStorage.setItem('popLockSavedThemes', JSON.stringify(savedThemes));
            
            // Hide editor but keep settings open
            customThemeEditor.classList.add('hidden');
            initMenus(); 
        }

        function deleteCustomTheme() {
            if (activeTheme.startsWith('CUSTOM_')) {
                delete THEMES[activeTheme];
                const savedThemes = {};
                for (const key in THEMES) {
                    if (key.startsWith('CUSTOM_')) {
                        savedThemes[key] = THEMES[key];
                    }
                }
                localStorage.setItem('popLockSavedThemes', JSON.stringify(savedThemes));
                setTheme('ARCADE');
            }
        }

        function loadSavedThemes() {
            const savedThemes = JSON.parse(localStorage.getItem('popLockSavedThemes') || '{}');
            Object.assign(THEMES, savedThemes);
            
            const savedSound = localStorage.getItem('popLockSoundPack');
            if (savedSound && SOUND_PACKS[savedSound]) {
                activeSoundPack = savedSound;
            }
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            centerX = canvas.width / 2;
            centerY = canvas.height / 2;
            radius = Math.min(canvas.width, canvas.height) * 0.22;
        }
        
        window.addEventListener('resize', resize);
        resize();
        loadSavedThemes();
        initMenus();

        function startGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            gameState = 'PLAYING';
            score = 0;
            angle = -Math.PI / 2; 
            direction = 1; 
            lastHitTime = 0; 
            
            const diff = DIFFICULTIES[activeDifficulty];
            velocity = diff.speed;
            
            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            winScreen.classList.add('hidden');
            
            scoreDisplay.classList.remove('hidden');
            scoreDisplay.innerText = MAX_SCORE - score;
            
            spawnTarget();
            
            setTimeout(() => {
                window.addEventListener('pointerdown', handleInput);
                window.addEventListener('touchstart', handleInput, { passive: false });
                window.addEventListener('keydown', handleKeyInput);
            }, 200);
            
            lastTime = performance.now();
            requestAnimationFrame(loop);
        }

        function returnToMenu() {
            gameState = 'IDLE';
            scoreDisplay.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            winScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            
            window.removeEventListener('pointerdown', handleInput);
            window.removeEventListener('touchstart', handleInput);
            window.removeEventListener('keydown', handleKeyInput);
            
            draw();
        }

        function openSettings() {
            startScreen.classList.add('opacity-0', 'pointer-events-none');
            settingsScreen.classList.remove('hidden');
            settingsScreen.classList.add('flex');
        }
        
        function closeSettings() {
            settingsScreen.classList.add('hidden');
            settingsScreen.classList.remove('flex');
            startScreen.classList.remove('opacity-0', 'pointer-events-none');
        }

        function spawnTarget() {
            let valid = false;
            while (!valid) {
                targetAngle = Math.random() * Math.PI * 2;
                let diff = Math.abs(getAngleDifference(angle, targetAngle));
                if (diff > 1.0 && diff < 4.5) { 
                    valid = true;
                }
            }
        }
        
        function gameOver() {
            gameState = 'GAMEOVER';
            window.removeEventListener('pointerdown', handleInput);
            window.removeEventListener('touchstart', handleInput);
            window.removeEventListener('keydown', handleKeyInput);
            
            scoreDisplay.classList.add('hidden');
            gameOverScreen.classList.remove('hidden');
            finalScoreEl.innerText = 'Remaining: ' + (MAX_SCORE - score);
            
            const intensity = 10;
            canvas.style.transform = `translate(${intensity}px, ${intensity}px)`;
            setTimeout(() => canvas.style.transform = `translate(-${intensity}px, -${intensity}px)`, 50);
            setTimeout(() => canvas.style.transform = `translate(${intensity}px, -${intensity}px)`, 100);
            setTimeout(() => canvas.style.transform = 'translate(0, 0)', 150);
        }
        
        function gameWin() {
            gameState = 'WON';
            window.removeEventListener('pointerdown', handleInput);
            window.removeEventListener('touchstart', handleInput);
            window.removeEventListener('keydown', handleKeyInput);
            
            scoreDisplay.classList.add('hidden');
            winScreen.classList.remove('hidden');
        }

        let lastInputTime = 0;
        function handleInput(e) {
            const now = performance.now();
            if (now - lastInputTime < 100) return;
            lastInputTime = now;

            if (gameState !== 'PLAYING') return;
            
            if (e && e.cancelable && e.preventDefault) e.preventDefault();

            const diffVal = getAngleDifference(angle, targetAngle);
            const currentDiffSettings = DIFFICULTIES[activeDifficulty];
            
            if (Math.abs(diffVal) <= currentDiffSettings.tol) {
                score++;
                lastHitTime = performance.now();
                scoreDisplay.innerText = MAX_SCORE - score;
                
                if (score >= MAX_SCORE) {
                    playSound('win');
                    gameWin();
                    return;
                }
                
                playSound('pop');
                
                direction *= -1;
                velocity = (currentDiffSettings.speed + (score * currentDiffSettings.inc)) * direction;
                
                const minDist = Math.PI / 3; 
                const maxDist = Math.PI * 1.5; 
                const range = maxDist - minDist;
                const dist = minDist + (Math.random() * range);
                
                targetAngle = angle + (dist * direction);
                targetAngle = targetAngle % (Math.PI * 2);
                if (targetAngle < 0) targetAngle += Math.PI * 2;
                
            } else {
                playSound('fail');
                gameOver();
            }
        }
        
        function handleKeyInput(e) {
            if (e.code === 'Space' || e.code === 'Enter') {
                handleInput();
            }
        }
        
        function getAngleDifference(a1, a2) {
            let diff = (a2 - a1 + Math.PI) % (Math.PI * 2) - Math.PI;
            if (diff < -Math.PI) diff += Math.PI * 2;
            return diff;
        }
        
        function loop(timestamp) {
            if (gameState !== 'PLAYING') {
                draw();
                return;
            }
            
            const dt = timestamp - lastTime;
            lastTime = timestamp;
            const safeDt = Math.min(dt, 50);
            
            angle += velocity * safeDt;
            angle = angle % (Math.PI * 2);
            if (angle < 0) angle += Math.PI * 2;
            
            draw();
            requestAnimationFrame(loop);
        }
        
        function draw() {
            const t = THEMES[activeTheme];
            const now = performance.now();
            const timeSinceHit = now - lastHitTime;
            const flashDuration = 400;
            const isFlashing = timeSinceHit < flashDuration;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Lock Body Base (Permanent)
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.lineWidth = 50; 
            ctx.strokeStyle = t.lock;
            ctx.stroke();

            // Flash Outlines
            if (isFlashing) {
                ctx.save();
                const progress = timeSinceHit / flashDuration;
                const alpha = 0.8 * (1 - progress);
                
                ctx.globalAlpha = alpha;
                ctx.globalCompositeOperation = 'lighter';
                
                ctx.lineWidth = 6;
                ctx.strokeStyle = t.progress;
                ctx.shadowColor = t.progress;
                ctx.shadowBlur = 50;
                
                // Outer rim ONLY
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius + 28, 0, Math.PI * 2);
                ctx.stroke();
                
                ctx.restore();
            }
            
            // Target Dot
            const targetX = centerX + Math.cos(targetAngle) * radius;
            const targetY = centerY + Math.sin(targetAngle) * radius;
            
            ctx.beginPath();
            ctx.arc(targetX, targetY, 32, 0, Math.PI * 2);
            ctx.fillStyle = t.target;
            ctx.shadowColor = t.target;
            ctx.shadowBlur = 25;
            ctx.fill();
            ctx.shadowBlur = 0; 
            
            // Ticker
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(angle);
            ctx.translate(radius, 0);
            
            ctx.fillStyle = t.ticker;
            ctx.shadowColor = t.ticker;
            ctx.shadowBlur = 15;
            
            roundRect(ctx, -40, -10, 80, 20, 10); 
            
            ctx.fill();
            ctx.restore();
        }
        
        function roundRect(ctx, x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.arcTo(x + w, y, x + w, y + h, r);
            ctx.arcTo(x + w, y + h, x, y + h, r);
            ctx.arcTo(x, y + h, x, y, r);
            ctx.arcTo(x, y, x + w, y, r);
            ctx.closePath();
        }

        // Listeners
        bindBtn(startBtn, startGame);
        bindBtn(retryBtn, startGame);
        bindBtn(playAgainBtn, startGame);
        bindBtn(settingsBtn, openSettings);
        bindBtn(closeSettingsBtn, closeSettings);
        bindBtn(menuBtn, returnToMenu);
        bindBtn(menuBtnWin, returnToMenu);
        bindBtn(saveThemeBtn, saveCustomTheme);
        bindBtn(deleteThemeBtn, deleteCustomTheme);
        
        // Custom Theme Listeners
        document.getElementById('customBg').addEventListener('input', (e) => updateCustomTheme('bg', e.target.value));
        document.getElementById('customLock').addEventListener('input', (e) => updateCustomTheme('lock', e.target.value));
        document.getElementById('customTarget').addEventListener('input', (e) => updateCustomTheme('target', e.target.value));
        document.getElementById('customTicker').addEventListener('input', (e) => updateCustomTheme('ticker', e.target.value));
        document.getElementById('customText').addEventListener('input', (e) => updateCustomTheme('text', e.target.value));
        document.getElementById('customProgress').addEventListener('input', (e) => updateCustomTheme('progress', e.target.value));
        
        customSpeedRange.addEventListener('input', updateCustomDiffDisplay);

        setTimeout(() => {
             resize();
             setTheme(activeTheme); // Initialize colors
        }, 100);

    </script>
</body>
</html>
