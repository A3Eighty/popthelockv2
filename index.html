<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pop the Lock</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;800&family=JetBrains+Mono:wght@700&display=swap');
        body {
            font-family: 'Segoe UI', sans-serif;
            touch-action: none;
            overflow: hidden;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); }
        
        .interactive {
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }
        
        /* Glass Utilities */
        .glass-panel {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .glass-card-deep {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 40px rgba(0,0,0,0.6);
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen w-screen flex flex-col items-center justify-center overflow-hidden transition-colors duration-500">

    <!-- Game Canvas -->
    <canvas id="gameCanvas" class="absolute top-0 left-0 w-full h-full z-0 touch-none"></canvas>

    <!-- UI Layer -->
    <div id="uiLayer" class="absolute top-0 left-0 w-full h-full z-10 pointer-events-none flex flex-col items-center justify-center">
        
        <!-- Score/Countdown -->
        <div id="scoreDisplay" class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-9xl font-bold opacity-80 pointer-events-none select-none font-mono">50</div>

        <!-- Start Screen -->
        <div id="startScreen" class="absolute w-full h-full flex flex-col items-center justify-center pointer-events-auto transition-opacity duration-300 z-20">
            <div class="flex flex-col items-center mb-16">
                <h1 id="gameTitle" class="text-5xl md:text-7xl font-extrabold mb-2 tracking-wider text-center transition-all duration-300">POP THE LOCK</h1>
                <p id="gameInstruction" class="text-sm md:text-base opacity-70 font-semibold tracking-widest text-center uppercase">
                    Tap when the <span id="instrBar">BAR</span> hits the <span id="instrDot">DOT</span>
                </p>
            </div>
            
            <button id="startBtn" class="interactive px-16 py-5 rounded-full text-xl font-black shadow-lg hover:scale-105 active:scale-95 transition-all duration-200 mb-6 bg-white text-black tracking-wider border-2 border-transparent">
                PLAY
            </button>
            
            <button id="settingsBtn" class="interactive px-8 py-2 rounded-full text-xs font-bold border border-white/20 hover:bg-white/10 hover:border-white/40 transition-all text-gray-300 tracking-widest">
                SETTINGS
            </button>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="hidden absolute w-full h-full flex-col items-center justify-start pt-12 pb-10 bg-gray-900/95 pointer-events-auto z-50 transition-all duration-300" style="touch-action: pan-y; overflow-y: auto;">
            <div id="settingsContainer" class="w-full max-w-md px-6 flex flex-col gap-8 pb-20">
                <div class="flex justify-between items-center border-b border-white/10 pb-4">
                    <h2 class="text-2xl font-bold tracking-tight">SETTINGS</h2>
                    <button id="closeSettingsBtn" class="interactive w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 transition">âœ•</button>
                </div>

                <!-- Visual Themes -->
                <div class="space-y-3">
                    <h3 class="text-xs uppercase tracking-widest text-gray-400 font-bold pl-1">Theme</h3>
                    <div id="themeGrid" class="grid grid-cols-3 gap-3">
                        <!-- Generated by JS -->
                    </div>
                </div>
                
                <!-- Custom Theme Editor -->
                <div id="customThemeEditor" class="hidden space-y-4 bg-gray-800/50 p-5 rounded-2xl border border-white/5">
                    <div class="flex justify-between items-center">
                        <h4 class="font-bold text-sm text-blue-300">Theme Editor</h4>
                        <button id="deleteThemeBtn" class="interactive text-[10px] bg-red-500/20 text-red-300 px-2 py-1 rounded hover:bg-red-500/30 hidden">DELETE</button>
                    </div>
                    
                    <input type="text" id="customThemeName" placeholder="My Theme Name" class="interactive w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500 transition">

                    <div class="grid grid-cols-2 gap-y-3 gap-x-4">
                        <div class="flex justify-between items-center">
                            <label class="text-xs text-gray-400">Background</label>
                            <input type="color" id="customBg" class="interactive w-6 h-6 rounded-full overflow-hidden bg-transparent cursor-pointer border-none">
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="text-xs text-gray-400">Lock Ring</label>
                            <input type="color" id="customLock" class="interactive w-6 h-6 rounded-full overflow-hidden bg-transparent cursor-pointer border-none">
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="text-xs text-gray-400">Target/Glow</label>
                            <input type="color" id="customTarget" class="interactive w-6 h-6 rounded-full overflow-hidden bg-transparent cursor-pointer border-none">
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="text-xs text-gray-400">Ticker Bar</label>
                            <input type="color" id="customTicker" class="interactive w-6 h-6 rounded-full overflow-hidden bg-transparent cursor-pointer border-none">
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="text-xs text-gray-400">Text Color</label>
                            <input type="color" id="customText" class="interactive w-6 h-6 rounded-full overflow-hidden bg-transparent cursor-pointer border-none">
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="text-xs text-gray-400">Flash</label>
                            <input type="color" id="customProgress" class="interactive w-6 h-6 rounded-full overflow-hidden bg-transparent cursor-pointer border-none">
                        </div>
                    </div>
                    
                    <button id="saveThemeBtn" class="interactive w-full py-3 mt-2 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold text-xs tracking-wide shadow-lg shadow-blue-900/20">SAVE THEME</button>
                </div>

                <!-- Options -->
                 <div class="bg-white/5 p-4 rounded-xl border border-white/5 flex justify-between items-center">
                    <span class="text-sm font-bold text-gray-200">Glass UI Mode</span>
                    <label class="relative inline-flex items-center cursor-pointer interactive">
                        <input type="checkbox" id="glassToggle" class="sr-only peer">
                        <div class="w-10 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                    </label>
                </div>

                <!-- Difficulty -->
                <div class="space-y-3">
                    <h3 class="text-xs uppercase tracking-widest text-gray-400 font-bold pl-1">Difficulty</h3>
                    <div id="diffGrid" class="flex gap-2 bg-black/20 p-1 rounded-lg">
                        <!-- Generated by JS -->
                    </div>
                    
                    <!-- Custom Diff Editor -->
                    <div id="customDiffEditor" class="hidden space-y-5 bg-gray-800/50 p-5 rounded-2xl mt-2 border border-white/5">
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-xs font-bold text-gray-300">Speed</span>
                                <span id="customSpeedVal" class="text-xs text-gray-400">Normal</span>
                            </div>
                            <input type="range" id="customSpeedRange" min="10" max="60" value="20" class="interactive w-full h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                        </div>
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-xs font-bold text-gray-300">Dot Size</span>
                                <span id="customSizeVal" class="text-xs text-gray-400">Normal</span>
                            </div>
                            <input type="range" id="customSizeRange" min="15" max="50" value="32" class="interactive w-full h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                        </div>
                    </div>
                </div>
                
                <!-- Audio -->
                <div class="space-y-3">
                    <h3 class="text-xs uppercase tracking-widest text-gray-400 font-bold pl-1">Sound Pack</h3>
                    <div id="soundGrid" class="grid grid-cols-2 gap-2">
                        <!-- Generated by JS -->
                    </div>
                    
                    <!-- Custom Sound Editor -->
                    <div id="customSoundEditor" class="hidden space-y-4 bg-gray-800/50 p-5 rounded-2xl border border-purple-500/20 mt-2 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 to-pink-500 opacity-50"></div>
                        <div class="flex justify-between items-center">
                             <h4 class="font-bold text-sm text-purple-300">Sound Lab</h4>
                             <select id="soundTypeSelector" class="interactive bg-black/30 border border-white/10 text-[10px] rounded px-2 py-1 text-gray-300 focus:outline-none">
                                 <option value="pop">Edit: Pop (Success)</option>
                                 <option value="fail">Edit: Fail (Death)</option>
                             </select>
                        </div>
                       
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-400">Waveform</span>
                                <select id="customWaveform" class="interactive bg-black/30 border border-white/10 text-xs rounded px-2 py-1 text-white focus:outline-none">
                                    <option value="sine">Sine (Smooth)</option>
                                    <option value="square">Square (Retro)</option>
                                    <option value="sawtooth">Sawtooth (Sharp)</option>
                                    <option value="triangle">Triangle (Soft)</option>
                                </select>
                            </div>
                            
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-xs text-gray-400">Start Pitch</span>
                                    <span id="startFreqVal" class="text-xs text-gray-500">800</span>
                                </div>
                                <input type="range" id="startFreq" min="50" max="2000" step="10" class="interactive w-full h-1.5 bg-gray-700 rounded-lg appearance-none accent-purple-500">
                            </div>
                            
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-xs text-gray-400">End Pitch</span>
                                    <span id="endFreqVal" class="text-xs text-gray-500">1200</span>
                                </div>
                                <input type="range" id="endFreq" min="50" max="2000" step="10" class="interactive w-full h-1.5 bg-gray-700 rounded-lg appearance-none accent-purple-500">
                            </div>
                            
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-xs text-gray-400">Duration</span>
                                    <span id="durationVal" class="text-xs text-gray-500">0.1s</span>
                                </div>
                                <input type="range" id="soundDuration" min="0.05" max="1.0" step="0.05" class="interactive w-full h-1.5 bg-gray-700 rounded-lg appearance-none accent-purple-500">
                            </div>
                            
                            <button id="testSoundBtn" class="interactive w-full py-2 bg-purple-600/80 hover:bg-purple-600 rounded-lg font-bold text-xs tracking-wide transition">TEST SOUND</button>
                        </div>
                    </div>
                </div>
                

            </div>
        </div>

        <!-- Game Over Screen (Refreshed) -->
        <div id="gameOverScreen" class="hidden absolute w-full h-full flex flex-col items-center justify-center z-40 bg-black/80 backdrop-blur-sm transition-all duration-500 p-6 pointer-events-auto">
            <div id="gameOverCard" class="relative w-full max-w-sm p-8 rounded-3xl flex flex-col items-center text-center transition-all duration-300 bg-gray-900 border border-gray-800 shadow-2xl">
                
                <h2 class="text-5xl font-black text-red-500 mb-1 tracking-tighter" style="text-shadow: 0 0 25px rgba(239,68,68,0.3);">FAILED</h2>
                <p class="text-xs text-gray-500 uppercase tracking-[0.2em] mb-8 font-bold">Game Over</p>
                
                <div class="flex items-end justify-center gap-2 mb-8 w-full">
                    <div class="flex flex-col items-center bg-white/5 p-4 rounded-2xl w-1/2 border border-white/5">
                        <span class="text-gray-400 text-[10px] uppercase tracking-widest font-bold mb-1">Score</span>
                        <span id="finalScore" class="text-4xl font-bold text-white">12</span>
                    </div>
                    <div class="flex flex-col items-center bg-white/5 p-4 rounded-2xl w-1/2 border border-white/5">
                        <span class="text-gray-400 text-[10px] uppercase tracking-widest font-bold mb-1">Remaining</span>
                        <span id="remainingScore" class="text-4xl font-bold text-yellow-500">38</span>
                    </div>
                </div>
                
                <button id="retryBtn" class="interactive w-full py-4 rounded-xl text-lg font-black bg-white text-black shadow-lg hover:scale-[1.02] active:scale-[0.98] transition-all mb-3">
                    TRY AGAIN
                </button>
                <button id="menuBtn" class="interactive w-full py-3 rounded-xl text-sm font-bold text-gray-400 hover:bg-white/5 hover:text-white transition-all">
                    MAIN MENU
                </button>
            </div>
        </div>

        <!-- Win Screen (Refreshed) -->
        <div id="winScreen" class="hidden absolute w-full h-full flex flex-col items-center justify-center z-40 bg-black/80 backdrop-blur-sm transition-all duration-500 p-6 pointer-events-auto">
            <div id="winCard" class="relative w-full max-w-sm p-8 rounded-3xl flex flex-col items-center text-center transition-all duration-300 bg-gray-900 border border-gray-800 shadow-2xl">
                
                <h2 class="text-5xl font-black text-green-400 mb-2 tracking-tighter" style="text-shadow: 0 0 25px rgba(74,222,128,0.3);">UNLOCKED</h2>
                <p class="text-sm text-gray-400 mb-8">All 50 Dots Popped!</p>
                
                <div class="mb-8">
                    <div class="text-6xl">ðŸ”“</div>
                </div>
                
                <button id="playAgainBtn" class="interactive w-full py-4 rounded-xl text-lg font-black bg-white text-black shadow-lg hover:scale-[1.02] active:scale-[0.98] transition-all mb-3">
                    PLAY AGAIN
                </button>
                <button id="menuBtnWin" class="interactive w-full py-3 rounded-xl text-sm font-bold text-gray-400 hover:bg-white/5 hover:text-white transition-all">
                    MAIN MENU
                </button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // UI Elements
        const uiLayer = document.getElementById('uiLayer');
        const startScreen = document.getElementById('startScreen');
        const settingsScreen = document.getElementById('settingsScreen');
        const settingsContainer = document.getElementById('settingsContainer');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const winScreen = document.getElementById('winScreen');
        const scoreDisplay = document.getElementById('scoreDisplay');
        
        // Cards
        const gameOverCard = document.getElementById('gameOverCard');
        const winCard = document.getElementById('winCard');
        
        // Buttons
        const startBtn = document.getElementById('startBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const retryBtn = document.getElementById('retryBtn');
        const playAgainBtn = document.getElementById('playAgainBtn');
        const menuBtn = document.getElementById('menuBtn');
        const menuBtnWin = document.getElementById('menuBtnWin');
        const finalScoreEl = document.getElementById('finalScore');
        const bestScoreEl = document.getElementById('bestScore');
        
        const gameTitle = document.getElementById('gameTitle');
        const gameInstruction = document.getElementById('gameInstruction');
        const instrBar = document.getElementById('instrBar');
        const instrDot = document.getElementById('instrDot');
        
        const themeGrid = document.getElementById('themeGrid');
        const diffGrid = document.getElementById('diffGrid');
        const soundGrid = document.getElementById('soundGrid');
        
        const customThemeEditor = document.getElementById('customThemeEditor');
        const customDiffEditor = document.getElementById('customDiffEditor');
        const deleteThemeBtn = document.getElementById('deleteThemeBtn');
        const saveThemeBtn = document.getElementById('saveThemeBtn');
        
        const customSpeedRange = document.getElementById('customSpeedRange');
        const customSpeedVal = document.getElementById('customSpeedVal');
        const customSizeRange = document.getElementById('customSizeRange');
        const customSizeVal = document.getElementById('customSizeVal');
        const glassToggle = document.getElementById('glassToggle');
        
        // Sound Editor
        const customSoundEditor = document.getElementById('customSoundEditor');
        const customWaveform = document.getElementById('customWaveform');
        const startFreqRange = document.getElementById('startFreq');
        const endFreqRange = document.getElementById('endFreq');
        const soundDurationRange = document.getElementById('soundDuration');
        const testSoundBtn = document.getElementById('testSoundBtn');
        const startFreqVal = document.getElementById('startFreqVal');
        const endFreqVal = document.getElementById('endFreqVal');
        const durationVal = document.getElementById('durationVal');

        // Data
        const THEMES = {
            'ARCADE': { name: 'Arcade', bg: '#111827', lock: '#374151', target: '#facc15', ticker: '#ef4444', text: '#ffffff', progress: '#22c55e' },
            'MINIMAL': { name: 'Minimal', bg: '#f3f4f6', lock: '#d1d5db', target: '#3b82f6', ticker: '#1f2937', text: '#1f2937', progress: '#10b981' },
            'NEON': { name: 'Neon', bg: '#000000', lock: '#262626', target: '#00ff00', ticker: '#ff00ff', text: '#00ff00', progress: '#ccff00' },
            'OCEAN': { name: 'Ocean', bg: '#0f172a', lock: '#1e293b', target: '#38bdf8', ticker: '#f472b6', text: '#e0f2fe', progress: '#2dd4bf' },
            'VAPOR': { name: 'Vapor', bg: '#2d1b4e', lock: '#4c1d95', target: '#00ffff', ticker: '#ff00ff', text: '#f3e8ff', progress: '#00ffff' },
            'FOREST': { name: 'Forest', bg: '#14532d', lock: '#166534', target: '#a3e635', ticker: '#fbbf24', text: '#f0fdf4', progress: '#4ade80' },
            'SUNSET': { name: 'Sunset', bg: '#431407', lock: '#7c2d12', target: '#fb923c', ticker: '#fde047', text: '#fff7ed', progress: '#f97316' },
            'MONO': { name: 'Mono', bg: '#000000', lock: '#333333', target: '#ffffff', ticker: '#888888', text: '#ffffff', progress: '#ffffff' },
            'AMOLED': { name: 'Amoled', bg: '#000000', lock: '#1a1a1a', target: '#ef4444', ticker: '#ffffff', text: '#ffffff', progress: '#ef4444' },
            'EMBER': { name: 'Ember', bg: '#1c1917', lock: '#ea580c', target: '#facc15', ticker: '#ffffff', text: '#ffedd5', progress: '#fb923c' },
            'CUSTOM': { name: 'Custom', bg: '#111827', lock: '#374151', target: '#facc15', ticker: '#ef4444', text: '#ffffff', progress: '#22c55e' }
        };

        const DIFFICULTIES = {
            'EASY': { label: 'Chill', speed: 0.0015, inc: 0.00008, tol: 0.35, size: 32 },
            'NORMAL': { label: 'Normal', speed: 0.0020, inc: 0.00012, tol: 0.28, size: 32 },
            'HARD': { label: 'Sweaty', speed: 0.0028, inc: 0.00018, tol: 0.22, size: 32 },
            'CUSTOM': { label: 'Custom', speed: 0.0020, inc: 0.00012, tol: 0.28, size: 32 }
        };

        const SOUND_PACKS = {
            'DEFAULT': { label: 'Classic' },
            'BUBBLE': { label: 'Bubble' },
            'RETRO': { label: '8-Bit' },
            'CLICK': { label: 'Mech' },
            'SPACE': { label: 'Space' },
            'LOFI': { label: 'Lofi' },
            'DREAMY': { label: 'Dreamy' },
            'WOOD': { label: 'Wood' },
            'BELL': { label: 'Bell' },
            'CUSTOM': { label: 'Custom' }
        };
        
        let customSounds = {
            pop: { waveform: 'sine', startFreq: 800, endFreq: 1200, duration: 0.1 },
            fail: { waveform: 'sawtooth', startFreq: 150, endFreq: 80, duration: 0.4 }
        };
        let currentEditType = 'pop';

        // State
        let activeTheme = 'ARCADE';
        let activeDifficulty = 'NORMAL';
        let activeSoundPack = 'DEFAULT';
        let glassMode = false;
        
        let gameState = 'IDLE'; 
        let score = 0;
        let highScore = 0;
        const MAX_SCORE = 50;
        
        let centerX, centerY, radius;
        let angle = 0; 
        let velocity = 0; 
        let targetAngle = 0; 
        let direction = 1; 
        let lastTime = 0;
        let lastHitTime = 0;
        let targetDistance = 0; // Distance to travel for new target

        // Audio
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            // Sound Pack Logic
            if (activeSoundPack === 'CUSTOM') {
                const params = customSounds[type];
                if (params && (type === 'pop' || type === 'fail')) {
                    osc.type = params.waveform;
                    osc.frequency.setValueAtTime(params.startFreq, now);
                    const targetFreq = Math.max(1, params.endFreq);
                    osc.frequency.exponentialRampToValueAtTime(targetFreq, now + params.duration);
                    gainNode.gain.setValueAtTime(0.4, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + params.duration);
                    osc.start(); osc.stop(now + params.duration + 0.05);
                    return;
                }
            }

            // Distinct Sound Packs
            if (activeSoundPack === 'BUBBLE') {
                 if (type === 'pop') {
                    osc.type = 'sine'; 
                    osc.frequency.setValueAtTime(400, now); 
                    osc.frequency.exponentialRampToValueAtTime(1200, now + 0.15); 
                    gainNode.gain.setValueAtTime(0.5, now); 
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.15); 
                    osc.start(); osc.stop(now + 0.15);
                } else if (type === 'fail') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(300, now); osc.frequency.linearRampToValueAtTime(100, now + 0.3); gainNode.gain.setValueAtTime(0.4, now); gainNode.gain.linearRampToValueAtTime(0.01, now + 0.3); osc.start(); osc.stop(now + 0.3);
                } else if (type === 'win') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(1200, now + 0.5); gainNode.gain.setValueAtTime(0.4, now); gainNode.gain.linearRampToValueAtTime(0.01, now + 0.5); osc.start(); osc.stop(now + 0.5);
                }
            }
            else if (activeSoundPack === 'RETRO') {
                 if (type === 'pop') {
                    osc.type = 'square'; 
                    osc.frequency.setValueAtTime(600, now); 
                    osc.frequency.setValueAtTime(800, now + 0.05);
                    gainNode.gain.setValueAtTime(0.3, now); 
                    gainNode.gain.setValueAtTime(0.3, now + 0.09);
                    gainNode.gain.setValueAtTime(0, now + 0.1); 
                    osc.start(); osc.stop(now + 0.1);
                } else if (type === 'fail') {
                    osc.type = 'square'; osc.frequency.setValueAtTime(200, now); osc.frequency.setValueAtTime(150, now + 0.1); osc.frequency.setValueAtTime(100, now + 0.2); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.4); osc.start(); osc.stop(now + 0.4);
                } else if (type === 'win') {
                    const freqs = [523, 659, 783, 1046];
                    freqs.forEach((f, i) => {
                        const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination);
                        o.type='square'; o.frequency.setValueAtTime(f, now + i*0.1);
                        g.gain.setValueAtTime(0.2, now + i*0.1); g.gain.linearRampToValueAtTime(0, now + i*0.1 + 0.1);
                        o.start(); o.stop(now + i*0.1 + 0.1);
                    });
                }
            }
            else if (activeSoundPack === 'CLICK') {
                 if (type === 'pop') {
                    osc.type = 'triangle'; 
                    osc.frequency.setValueAtTime(2500, now); 
                    gainNode.gain.setValueAtTime(0.8, now); 
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.03); 
                    osc.start(); osc.stop(now + 0.03);
                } else if (type === 'fail') {
                    osc.type = 'square'; osc.frequency.setValueAtTime(100, now); gainNode.gain.setValueAtTime(0.5, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(); osc.stop(now + 0.1);
                } else if (type === 'win') {
                    for(let i=0; i<3; i++) {
                        const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination);
                        o.type='triangle'; o.frequency.setValueAtTime(2000 + i*500, now + i*0.05);
                        g.gain.setValueAtTime(0.5, now + i*0.05); g.gain.exponentialRampToValueAtTime(0.01, now + i*0.05 + 0.03);
                        o.start(); o.stop(now + i*0.05 + 0.03);
                    }
                }
            }
            else if (activeSoundPack === 'SPACE') {
                 if (type === 'pop') {
                    osc.type = 'sawtooth'; 
                    osc.frequency.setValueAtTime(800, now); 
                    osc.frequency.linearRampToValueAtTime(2000, now + 0.2); 
                    gainNode.gain.setValueAtTime(0.2, now); 
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.2); 
                    osc.start(); osc.stop(now + 0.2);
                } else if (type === 'fail') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(50, now + 0.5); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.5); osc.start(); osc.stop(now + 0.5);
                } else if (type === 'win') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(440, now); osc.frequency.linearRampToValueAtTime(880, now+0.5); gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.linearRampToValueAtTime(0, now+1.0); osc.start(); osc.stop(now+1.0);
                }
            }
            else if (activeSoundPack === 'LOFI') {
                 if (type === 'pop') {
                    osc.type = 'triangle'; 
                    osc.frequency.setValueAtTime(440, now); 
                    gainNode.gain.setValueAtTime(0.5, now); 
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1); 
                    osc.start(); osc.stop(now + 0.1);
                } else if (type === 'fail') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(100, now); gainNode.gain.setValueAtTime(0.5, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3); osc.start(); osc.stop(now + 0.3);
                } else if (type === 'win') {
                    const freqs = [349, 440, 523]; 
                    freqs.forEach((f) => {
                        const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination);
                        o.type='triangle'; o.frequency.setValueAtTime(f, now);
                        g.gain.setValueAtTime(0.1, now); g.gain.exponentialRampToValueAtTime(0.01, now + 0.8);
                        o.start(); o.stop(now + 0.8);
                    });
                }
            }
            else if (activeSoundPack === 'WOOD') {
                 if (type === 'pop') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); gainNode.gain.setValueAtTime(0.6, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05); osc.start(); osc.stop(now + 0.05);
                } else if (type === 'fail') {
                    osc.type = 'square'; osc.frequency.setValueAtTime(100, now); gainNode.gain.setValueAtTime(0.4, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2); osc.start(); osc.stop(now + 0.2);
                } else if (type === 'win') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(523, now); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5); osc.start(); osc.stop(now + 0.5);
                }
            }
            else if (activeSoundPack === 'BELL') {
                 if (type === 'pop') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(1200, now); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5); osc.start(); osc.stop(now + 0.5);
                } else if (type === 'fail') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4); osc.start(); osc.stop(now + 0.4);
                } else if (type === 'win') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(880, now); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 1.5); osc.start(); osc.stop(now + 1.5);
                }
            }
            else if (activeSoundPack === 'DREAMY') {
                if (type === 'pop') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(523, now); gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.5); osc.start(); osc.stop(now + 0.5);
                } else if (type === 'fail') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.5); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.5); osc.start(); osc.stop(now + 0.5);
                } else if (type === 'win') {
                    const freqs = [523, 659, 783]; freqs.forEach((f,i) => {
                        const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type='sine'; o.frequency.setValueAtTime(f, now+i*0.1); g.gain.setValueAtTime(0.1, now+i*0.1); g.gain.linearRampToValueAtTime(0, now+1.5); o.start(); o.stop(now+1.5);
                    });
                }
            }
            // Default (Classic)
            else {
                if (type === 'pop') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.08); gainNode.gain.setValueAtTime(0.4, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.08); osc.start(); osc.stop(now + 0.08);
                } else if (type === 'fail') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(80, now + 0.4); gainNode.gain.setValueAtTime(0.4, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4); osc.start(); osc.stop(now + 0.4);
                } else if (type === 'win') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(523, now); osc.frequency.setValueAtTime(659, now + 0.1); osc.frequency.setValueAtTime(783, now + 0.2); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.8); osc.start(); osc.stop(now + 0.8);
                }
            }
        }

        function bindBtn(idOrEl, action) {
            const el = typeof idOrEl === 'string' ? document.getElementById(idOrEl) : idOrEl;
            if (!el) return;
            
            // Use standard click for everything to be safe with scrolling
            el.addEventListener('click', (e) => {
                if (el.tagName !== 'INPUT' && el.tagName !== 'SELECT') {
                    e.preventDefault();
                }
                action(e);
            });
        }
        
        function initMenus() {
            themeGrid.innerHTML = '';
            for (const [key, theme] of Object.entries(THEMES)) {
                if (key.startsWith('CUSTOM') && key !== 'CUSTOM' && !key.includes('_')) continue; // Internal logic skip

                const btn = document.createElement('button');
                const isCustom = key.startsWith('CUSTOM');
                const isSaved = key.startsWith('CUSTOM_');
                
                btn.className = `interactive p-3 rounded-xl font-bold text-[10px] uppercase tracking-wider transition-transform active:scale-95 border relative overflow-hidden h-16 flex items-center justify-center text-center`;
                btn.style.backgroundColor = theme.bg;
                btn.style.color = theme.target;
                btn.style.borderColor = activeTheme === key ? theme.target : theme.lock;
                btn.style.boxShadow = activeTheme === key ? `0 0 15px ${theme.target}40` : 'none';
                btn.innerText = theme.name;
                
                if (isSaved) {
                     const indicator = document.createElement('div');
                     indicator.className = "absolute top-1 right-1 w-1.5 h-1.5 rounded-full bg-blue-400 shadow-sm";
                     btn.appendChild(indicator);
                }
                
                bindBtn(btn, () => setTheme(key));
                themeGrid.appendChild(btn);
            }
            
            diffGrid.innerHTML = '';
            for (const [key, diff] of Object.entries(DIFFICULTIES)) {
                const btn = document.createElement('button');
                btn.className = `interactive flex-1 py-2 rounded-md font-bold text-[10px] uppercase tracking-wider transition-colors ${activeDifficulty === key ? 'bg-white text-black shadow-sm' : 'text-gray-400 hover:bg-white/10 hover:text-white'}`;
                btn.innerText = diff.label;
                bindBtn(btn, () => setDifficulty(key));
                diffGrid.appendChild(btn);
            }

            soundGrid.innerHTML = '';
            for (const [key, pack] of Object.entries(SOUND_PACKS)) {
                const btn = document.createElement('button');
                btn.className = `interactive flex-1 py-2 rounded-md font-bold text-[10px] uppercase tracking-wider transition-colors ${activeSoundPack === key ? 'bg-purple-500 text-white shadow-sm' : 'text-gray-400 hover:bg-white/10 hover:text-white'}`;
                btn.innerText = pack.label;
                bindBtn(btn, () => setSoundPack(key));
                soundGrid.appendChild(btn);
            }
        }
        
        function setTheme(key) {
            activeTheme = key;
            const t = THEMES[key];
            document.body.style.backgroundColor = t.bg;
            document.body.style.color = t.text;

            if (key.startsWith('CUSTOM')) {
                customThemeEditor.classList.remove('hidden');
                document.getElementById('customBg').value = t.bg;
                document.getElementById('customLock').value = t.lock;
                document.getElementById('customTarget').value = t.target;
                document.getElementById('customTicker').value = t.ticker;
                document.getElementById('customText').value = t.text;
                document.getElementById('customProgress').value = t.progress;
                document.getElementById('customThemeName').value = t.name;
                deleteThemeBtn.classList.toggle('hidden', key === 'CUSTOM');
            } else {
                customThemeEditor.classList.add('hidden');
            }
            
            // Text Colors
            gameTitle.style.color = t.target;
            gameTitle.style.textShadow = `0 0 25px ${t.target}60`; 
            instrBar.style.color = t.ticker;
            instrDot.style.color = t.target;
            
            // Stats Colors
            const remainingScoreEl = document.getElementById('remainingScore');
            if (remainingScoreEl) {
                remainingScoreEl.style.color = t.target;
                remainingScoreEl.classList.remove('text-yellow-500'); 
            }

            // Card Colors & Backgrounds
            if (gameOverCard) {
                gameOverCard.style.borderColor = t.lock;
                gameOverCard.style.backgroundColor = t.bg;
                gameOverCard.style.color = t.text;
            }
            if (winCard) {
                winCard.style.borderColor = t.target;
                winCard.style.backgroundColor = t.bg;
                winCard.style.color = t.text;
            }
            
            // Button Colors
            const playBtns = [startBtn, retryBtn, playAgainBtn];
            playBtns.forEach(btn => {
                btn.style.backgroundColor = t.target;
                btn.style.boxShadow = `0 0 20px ${t.target}50`;
                
                // Contrast check for text color
                const hex = t.target.replace('#', '');
                const r = parseInt(hex.substr(0,2),16);
                const g = parseInt(hex.substr(2,2),16);
                const b = parseInt(hex.substr(4,2),16);
                const yiq = ((r*299)+(g*587)+(b*114))/1000;
                btn.style.color = (yiq >= 128) ? '#000000' : '#ffffff';
            });

            applyGlassState();
            initMenus();
            draw();
        }

        function applyGlassState() {
            if (glassMode) {
                settingsScreen.classList.remove('bg-gray-900/95');
                settingsScreen.classList.add('bg-gray-900/60', 'backdrop-blur-xl');
                
                // We don't set bg colors on cards here anymore to respect theme colors
                if (gameOverCard) gameOverCard.classList.add('backdrop-blur-lg');
                if (winCard) winCard.classList.add('backdrop-blur-lg');
                
            } else {
                settingsScreen.classList.add('bg-gray-900/95');
                settingsScreen.classList.remove('bg-gray-900/60', 'backdrop-blur-xl');
                
                if (gameOverCard) gameOverCard.classList.remove('backdrop-blur-lg');
                if (winCard) winCard.classList.remove('backdrop-blur-lg');
            }
            
            // Always ensure theme borders applied
            if (THEMES[activeTheme]) {
                 if (gameOverCard) gameOverCard.style.borderColor = THEMES[activeTheme].lock;
                 if (winCard) winCard.style.borderColor = THEMES[activeTheme].target;
            }
        }

        function toggleGlass() {
            glassMode = !glassMode;
            glassToggle.checked = glassMode;
            localStorage.setItem('popLockGlassMode', glassMode);
            applyGlassState();
        }
        
        function setDifficulty(key) {
            activeDifficulty = key;
            if (key === 'CUSTOM') {
                customDiffEditor.classList.remove('hidden');
                const s = DIFFICULTIES['CUSTOM'];
                customSpeedRange.value = Math.round(s.speed * 10000);
                customSizeRange.value = s.size;
                updateCustomDiffDisplay();
            } else {
                customDiffEditor.classList.add('hidden');
            }
            initMenus();
        }
        
        function updateCustomDiffDisplay() {
            const speedVal = parseInt(customSpeedRange.value);
            let speedText = "Normal";
            if (speedVal < 15) speedText = "Chill";
            else if (speedVal < 30) speedText = "Fast";
            else if (speedVal < 45) speedText = "Sweaty";
            else speedText = "Insane";
            
            customSpeedVal.innerText = speedText + " (" + speedVal + ")";
            DIFFICULTIES['CUSTOM'].speed = speedVal / 10000;
            
            const sizeVal = parseInt(customSizeRange.value);
            customSizeVal.innerText = sizeVal + "px";
            DIFFICULTIES['CUSTOM'].size = sizeVal;
        }

        function setSoundPack(key) {
            activeSoundPack = key;
            localStorage.setItem('popLockSoundPack', key);
            playSound('pop'); 
            customSoundEditor.classList.toggle('hidden', key !== 'CUSTOM');
            initMenus();
        }

        function updateCustomTheme(prop, val) {
            if (activeTheme.startsWith('CUSTOM')) {
                THEMES[activeTheme][prop] = val;
                setTheme(activeTheme);
            }
        }

        function saveCustomTheme() {
            const nameInput = document.getElementById('customThemeName');
            let name = nameInput.value.trim() || 'My Theme';
            
            if (activeTheme === 'CUSTOM') {
                const newKey = 'CUSTOM_' + Date.now();
                THEMES[newKey] = { ...THEMES['CUSTOM'], name: name };
                activeTheme = newKey;
            } else if (activeTheme.startsWith('CUSTOM_')) {
                THEMES[activeTheme].name = name;
            }

            const savedThemes = {};
            for (const key in THEMES) {
                if (key.startsWith('CUSTOM_')) {
                    savedThemes[key] = THEMES[key];
                }
            }
            localStorage.setItem('popLockSavedThemes', JSON.stringify(savedThemes));
            customThemeEditor.classList.add('hidden'); // Close editor
            initMenus(); 
        }

        function deleteCustomTheme() {
            if (activeTheme.startsWith('CUSTOM_')) {
                delete THEMES[activeTheme];
                const savedThemes = {};
                for (const key in THEMES) {
                    if (key.startsWith('CUSTOM_')) savedThemes[key] = THEMES[key];
                }
                localStorage.setItem('popLockSavedThemes', JSON.stringify(savedThemes));
                setTheme('ARCADE');
            }
        }

        function loadSavedThemes() {
            const savedThemes = JSON.parse(localStorage.getItem('popLockSavedThemes') || '{}');
            Object.assign(THEMES, savedThemes);
            
            const savedSound = localStorage.getItem('popLockSoundPack');
            if (savedSound && SOUND_PACKS[savedSound]) activeSoundPack = savedSound;

            const savedGlass = localStorage.getItem('popLockGlassMode');
            if (savedGlass === 'true') {
                glassMode = true;
                glassToggle.checked = true;
            }
            
            highScore = parseInt(localStorage.getItem('popLockHighScore') || '0');
            
            const savedCustomSound = localStorage.getItem('popLockCustomSound');
            if (savedCustomSound) {
                try {
                    const parsed = JSON.parse(savedCustomSound);
                    if (parsed.waveform) customSounds.pop = parsed;
                    else customSounds = parsed;
                } catch(e) {}
            }
            updateSoundEditorUI();
        }
        
        function updateSoundEditorUI() {
            const params = customSounds[currentEditType];
            if (!params) return;
            customWaveform.value = params.waveform;
            startFreqRange.value = params.startFreq;
            endFreqRange.value = params.endFreq;
            soundDurationRange.value = params.duration;
            startFreqVal.innerText = params.startFreq;
            endFreqVal.innerText = params.endFreq;
            durationVal.innerText = params.duration + 's';
        }
        
        function updateCustomSound() {
            customSounds[currentEditType] = {
                waveform: customWaveform.value,
                startFreq: parseInt(startFreqRange.value),
                endFreq: parseInt(endFreqRange.value),
                duration: parseFloat(soundDurationRange.value)
            };
            updateSoundEditorUI();
            localStorage.setItem('popLockCustomSound', JSON.stringify(customSounds));
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            centerX = canvas.width / 2;
            centerY = canvas.height / 2;
            radius = Math.min(canvas.width, canvas.height) * 0.22;
            draw();
        }
        
        window.addEventListener('resize', resize);
        
        const soundTypeSelector = document.getElementById('soundTypeSelector');
        soundTypeSelector.addEventListener('change', (e) => {
            currentEditType = e.target.value;
            updateSoundEditorUI();
        });

        customWaveform.addEventListener('change', updateCustomSound);
        startFreqRange.addEventListener('input', updateCustomSound);
        endFreqRange.addEventListener('input', updateCustomSound);
        soundDurationRange.addEventListener('input', updateCustomSound);
        glassToggle.addEventListener('change', toggleGlass);
        
        bindBtn(testSoundBtn, () => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const temp = activeSoundPack;
            activeSoundPack = 'CUSTOM';
            playSound(currentEditType); 
            activeSoundPack = temp;
        });

        loadSavedThemes();
        initMenus();
        resize();
        setTheme(activeTheme);

        function startGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            gameState = 'PLAYING';
            score = 0;
            angle = -Math.PI / 2; 
            direction = 1; 
            lastHitTime = 0; 
            
            const diff = DIFFICULTIES[activeDifficulty];
            velocity = diff.speed;
            
            startScreen.classList.add('opacity-0', 'pointer-events-none');
            gameOverScreen.classList.add('hidden');
            winScreen.classList.add('hidden');
            
            scoreDisplay.classList.remove('hidden');
            scoreDisplay.innerText = MAX_SCORE - score;
            
            spawnTarget();
            
            // Input Listeners
            setTimeout(() => {
                // Main game input uses touchstart for zero latency
                window.addEventListener('pointerdown', handleInput);
                window.addEventListener('touchstart', handleInput, { passive: false });
                window.addEventListener('keydown', handleKeyInput);
            }, 100);
            
            lastTime = performance.now();
            requestAnimationFrame(loop);
        }

        function returnToMenu() {
            gameState = 'IDLE';
            scoreDisplay.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            winScreen.classList.add('hidden');
            startScreen.classList.remove('opacity-0', 'pointer-events-none');
            
            window.removeEventListener('pointerdown', handleInput);
            window.removeEventListener('touchstart', handleInput);
            window.removeEventListener('keydown', handleKeyInput);
            
            draw();
        }

        function openSettings() {
            settingsScreen.classList.remove('hidden');
            settingsScreen.classList.add('flex');
        }
        
        function closeSettings() {
            settingsScreen.classList.add('hidden');
            settingsScreen.classList.remove('flex');
        }

        function spawnTarget() {
            // Logic for random distance
            const minDist = Math.PI / 3; 
            const maxDist = Math.PI * 1.5; 
            const range = maxDist - minDist;
            const dist = minDist + (Math.random() * range);
            
            targetAngle = angle + (dist * direction);
            targetAngle = targetAngle % (Math.PI * 2);
            if (targetAngle < 0) targetAngle += Math.PI * 2;
        }
        
        function gameOver() {
            gameState = 'GAMEOVER';
            window.removeEventListener('pointerdown', handleInput);
            window.removeEventListener('touchstart', handleInput);
            window.removeEventListener('keydown', handleKeyInput);
            
            scoreDisplay.classList.add('hidden');
            gameOverScreen.classList.remove('hidden');
            
            // Update Scores
            finalScoreEl.innerText = score;
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('popLockHighScore', highScore);
            }
            
            const remaining = Math.max(0, MAX_SCORE - score);
            const remainingEl = document.getElementById('remainingScore');
            if(remainingEl) remainingEl.innerText = remaining;
            
            // Shake
            const intensity = 10;
            canvas.style.transform = `translate(${intensity}px, ${intensity}px)`;
            setTimeout(() => canvas.style.transform = `translate(-${intensity}px, -${intensity}px)`, 50);
            setTimeout(() => canvas.style.transform = `translate(${intensity}px, -${intensity}px)`, 100);
            setTimeout(() => canvas.style.transform = 'translate(0, 0)', 150);
        }
        
        function gameWin() {
            gameState = 'WON';
            window.removeEventListener('pointerdown', handleInput);
            window.removeEventListener('touchstart', handleInput);
            window.removeEventListener('keydown', handleKeyInput);
            
            scoreDisplay.classList.add('hidden');
            winScreen.classList.remove('hidden');
        }

        let lastInputTime = 0;
        function handleInput(e) {
            const now = performance.now();
            if (now - lastInputTime < 100) return; // Debounce
            lastInputTime = now;

            if (gameState !== 'PLAYING') return;
            
            if (e && e.cancelable && e.preventDefault) e.preventDefault();

            const diffVal = getAngleDifference(angle, targetAngle);
            const currentDiffSettings = DIFFICULTIES[activeDifficulty];
            
            let effectiveTol = currentDiffSettings.tol;
            if (currentDiffSettings.size && radius > 0) {
                const tickerHalfWidthAngle = 10 / radius; 
                const targetHalfWidthAngle = currentDiffSettings.size / radius;
                effectiveTol = tickerHalfWidthAngle + targetHalfWidthAngle + 0.05; 
            }

            if (Math.abs(diffVal) <= effectiveTol) {
                score++;
                lastHitTime = performance.now();
                scoreDisplay.innerText = MAX_SCORE - score;
                
                if (score >= MAX_SCORE) {
                    playSound('win');
                    gameWin();
                    return;
                }
                
                playSound('pop');
                
                direction *= -1;
                velocity = (currentDiffSettings.speed + (score * currentDiffSettings.inc)) * direction;
                spawnTarget();
                
            } else {
                playSound('fail');
                gameOver();
            }
        }
        
        function handleKeyInput(e) {
            if (e.code === 'Space' || e.code === 'Enter') {
                handleInput();
            }
        }
        
        function getAngleDifference(a1, a2) {
            let diff = (a2 - a1 + Math.PI) % (Math.PI * 2) - Math.PI;
            if (diff < -Math.PI) diff += Math.PI * 2;
            return diff;
        }
        
        function loop(timestamp) {
            if (gameState !== 'PLAYING') {
                draw();
                return;
            }
            
            const dt = timestamp - lastTime;
            lastTime = timestamp;
            const safeDt = Math.min(dt, 50);
            
            angle += velocity * safeDt;
            angle = angle % (Math.PI * 2);
            if (angle < 0) angle += Math.PI * 2;
            
            draw();
            requestAnimationFrame(loop);
        }
        
        function draw() {
            const t = THEMES[activeTheme];
            const now = performance.now();
            const timeSinceHit = now - lastHitTime;
            const flashDuration = 400;
            const isFlashing = timeSinceHit < flashDuration;
            const diffSettings = DIFFICULTIES[activeDifficulty];
            const dotSize = diffSettings.size || 32;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw Base Lock
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.lineWidth = 50; 
            
            if (isFlashing) {
                // Flash Logic
                const progress = timeSinceHit / flashDuration;
                const alpha = 0.8 * (1 - progress);
                
                ctx.strokeStyle = t.lock; 
                ctx.stroke();
                
                // Outer Glow Flash
                ctx.save();
                ctx.globalAlpha = alpha;
                ctx.globalCompositeOperation = 'lighter';
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius + 26, 0, Math.PI * 2); // Outer ring
                ctx.lineWidth = 4;
                ctx.strokeStyle = t.progress;
                ctx.shadowColor = t.progress;
                ctx.shadowBlur = 50;
                ctx.stroke();
                

                ctx.restore();
                
            } else {
                ctx.strokeStyle = t.lock;
                ctx.stroke();
            }

            // Target Dot
            const targetX = centerX + Math.cos(targetAngle) * radius;
            const targetY = centerY + Math.sin(targetAngle) * radius;
            
            ctx.beginPath();
            ctx.arc(targetX, targetY, dotSize, 0, Math.PI * 2);
            ctx.fillStyle = t.target;
            ctx.shadowColor = t.target;
            ctx.shadowBlur = 30;
            ctx.fill();
            ctx.shadowBlur = 0; 
            
            // Ticker Bar
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(angle);
            ctx.translate(radius, 0);
            
            ctx.fillStyle = t.ticker;
            ctx.shadowColor = t.ticker;
            ctx.shadowBlur = 15;
            
            // Round Rect Ticker
            const w = 80; const h = 20; const r = 10;
            ctx.beginPath();
            ctx.moveTo(-w/2 + r, -h/2);
            ctx.arcTo(w/2, -h/2, w/2, h/2, r);
            ctx.arcTo(w/2, h/2, -w/2, h/2, r);
            ctx.arcTo(-w/2, h/2, -w/2, -h/2, r);
            ctx.arcTo(-w/2, -h/2, w/2, -h/2, r);
            ctx.closePath();
            
            ctx.fill();
            ctx.restore();
        }

        bindBtn(startBtn, startGame);
        bindBtn(retryBtn, startGame);
        bindBtn(playAgainBtn, startGame);
        bindBtn(settingsBtn, openSettings);
        bindBtn(closeSettingsBtn, closeSettings);
        bindBtn(menuBtn, returnToMenu);
        bindBtn(menuBtnWin, returnToMenu);
        bindBtn(saveThemeBtn, saveCustomTheme);
        bindBtn(deleteThemeBtn, deleteCustomTheme);
        
        document.getElementById('customBg').addEventListener('input', (e) => updateCustomTheme('bg', e.target.value));
        document.getElementById('customLock').addEventListener('input', (e) => updateCustomTheme('lock', e.target.value));
        document.getElementById('customTarget').addEventListener('input', (e) => updateCustomTheme('target', e.target.value));
        document.getElementById('customTicker').addEventListener('input', (e) => updateCustomTheme('ticker', e.target.value));
        document.getElementById('customText').addEventListener('input', (e) => updateCustomTheme('text', e.target.value));
        document.getElementById('customProgress').addEventListener('input', (e) => updateCustomTheme('progress', e.target.value));
        
        customSpeedRange.addEventListener('input', updateCustomDiffDisplay);
        customSizeRange.addEventListener('input', updateCustomDiffDisplay);
    </script>
</body>
</html>